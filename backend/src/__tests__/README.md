# PromptEngine ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆ

PromptEngine ã®åŒ…æ‹¬çš„ãªãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’æä¾›ã—ã¾ã™ã€‚

## ğŸ“ ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

```
backend/src/__tests__/
â”œâ”€â”€ PromptEngine.test.ts       # ãƒ¡ã‚¤ãƒ³ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆ
â”œâ”€â”€ setup.ts                   # Jest ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
â””â”€â”€ test-runner.ts             # ã‚«ã‚¹ã‚¿ãƒ ãƒ†ã‚¹ãƒˆãƒ©ãƒ³ãƒŠãƒ¼
```

## ğŸ§ª ãƒ†ã‚¹ãƒˆã‚«ãƒ†ã‚´ãƒª

### A. generatePrompt() çµ±åˆãƒ†ã‚¹ãƒˆ
- **A-1**: æ­£å¸¸ç³»ï¼ˆå…¨è¨­å®šå­˜åœ¨ï¼‰
- **A-2**: ã‚¤ãƒ™ãƒ³ãƒˆãªã—ã®æ—¥
- **A-3**: ãƒˆãƒ¬ãƒ³ãƒ‰ç„¡åŠ¹
- **A-4**: Persona ãªã—
- **A-5**: DynamoDB ã‚¨ãƒ©ãƒ¼ â†’ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
- **A-6**: å¤–éƒ¨API ã‚¨ãƒ©ãƒ¼ â†’ å®‰å…¨å‡¦ç†

### B. å€‹åˆ¥ãƒ¡ã‚½ãƒƒãƒ‰å˜ä½“ãƒ†ã‚¹ãƒˆ

#### B-1. getCurrentWeekTheme()
```typescript
// ãƒ†ã‚¹ãƒˆè¦³ç‚¹
- æ›œæ—¥ã”ã¨ï¼ˆ0-6ï¼‰ã®ãƒ†ãƒ¼ãƒå–å¾—
- æœªè¨­å®šæ™‚ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ 'Today is a great day!'
```

#### B-2. getTodaysEvents()
```typescript
// ãƒ†ã‚¹ãƒˆè¦³ç‚¹  
- ä»Šæ—¥ã®æ—¥ä»˜ã®ã‚¤ãƒ™ãƒ³ãƒˆã®ã¿æŠ½å‡º
- éå»ãƒ»æœªæ¥ã®æ—¥ä»˜ã‚¤ãƒ™ãƒ³ãƒˆé™¤å¤–
```

#### B-3. fetchTrends()
```typescript
// ãƒ†ã‚¹ãƒˆè¦³ç‚¹
- mixRatio ã«ã‚ˆã‚‹ä»¶æ•°åˆ¶å¾¡ï¼ˆ0-100%ï¼‰
- excludeCategories ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
- è¤‡æ•°ã‚½ãƒ¼ã‚¹ï¼ˆGoogle/Yahooï¼‰çµ±åˆ
- API ã‚¨ãƒ©ãƒ¼æ™‚ã®å®‰å…¨å‡¦ç†
```

#### B-4. generateToneDescription()
```typescript
// ãƒ†ã‚¹ãƒˆè¦³ç‚¹
- politeness >= 80 â†’ 'éå¸¸ã«ä¸å¯§ã§ç¤¼å„€æ­£ã—ã„æ•¬èª'
- politeness < 40 & casualness >= 70 â†’ 'ã¨ã¦ã‚‚ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«'
- positivity >= 90 â†’ 'éå¸¸ã«å‰å‘ãã§æ˜ã‚‹ãæ¥½è¦³çš„'
- emojiUsage < 20 â†’ 'çµµæ–‡å­—ã‚’ä½¿ã‚ãªã„'
- metaphorUsage >= 70 â†’ 'æ¯”å–©ã‚„ä¾‹ãˆè©±ã‚’å¤šç”¨'
```

#### B-5. generatePersonaContext()
```typescript
// ãƒ†ã‚¹ãƒˆè¦³ç‚¹
- traits é…åˆ—ã‹ã‚‰ã®æ–‡å­—åˆ—ç”Ÿæˆ
- speakingStyle åæ˜ 
- commonTopics çµ±åˆ
- ç©ºãƒ‡ãƒ¼ã‚¿æ™‚ã®å®‰å…¨å‡¦ç†
```

### C. æ–‡å­—åˆ—ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå“è³ªãƒ†ã‚¹ãƒˆ

#### C-1. ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ§‹æˆ
```typescript
// å¿…é ˆã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç¢ºèª
- 'ã‚ãªãŸã¯æ—¥æœ¬ã®SNSæŠ•ç¨¿ã‚’ä½œæˆã™ã‚‹AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ'
- 'Xï¼ˆæ—§Twitterï¼‰ç”¨'
- '280æ–‡å­—ä»¥å†…'
- 'ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ãƒ»URLï¼šV1ã§ã¯åŸºæœ¬çš„ã«ä½¿ç”¨ã—ãªã„'
- 'å‰µé€ æ€§ãƒ¬ãƒ™ãƒ«'
```

#### C-2. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ§‹æˆ
```typescript
// å¿…é ˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ç¢ºèª
- '# ä»Šæ—¥ã®æŠ•ç¨¿æ¡ä»¶'
- '## ä»Šæ—¥ã®ãƒ†ãƒ¼ãƒï¼ˆæ›œæ—¥ãƒ†ãƒ¼ãƒï¼‰'
- '## äººæ ¼ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«'
- '## ä½¿ç”¨ã™ã‚‹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ'
- '## å‡ºåŠ›æŒ‡ç¤º'
```

#### C-3. ã‚¨ãƒ©ãƒ¼æ–‡å­—åˆ—æ··å…¥ãƒã‚§ãƒƒã‚¯
```typescript
// ç¦æ­¢ãƒ‘ã‚¿ãƒ¼ãƒ³ç¢ºèª
- '[object Object]' éå«æœ‰
- 'undefined' æ–‡å­—åˆ—éå«æœ‰
- é©åˆ‡ãªæ–‡å­—ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°
```

## ğŸš€ ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ–¹æ³•

### æ¨™æº– Jest ãƒ†ã‚¹ãƒˆ
```bash
# å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
npm test

# ã‚«ãƒãƒ¬ãƒƒã‚¸ä»˜ããƒ†ã‚¹ãƒˆ
npm run test:coverage

# ã‚¦ã‚©ãƒƒãƒãƒ¢ãƒ¼ãƒ‰
npm run test:watch

# ç‰¹å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿
npm test PromptEngine
```

### ã‚«ã‚¹ã‚¿ãƒ ãƒ†ã‚¹ãƒˆãƒ©ãƒ³ãƒŠãƒ¼ï¼ˆå‹ã‚¨ãƒ©ãƒ¼å›é¿ï¼‰
```bash
# TypeScript å‹ã‚¨ãƒ©ãƒ¼ã‚’å›é¿ã—ã¦ãƒ†ã‚¹ãƒˆä»•æ§˜ç¢ºèª
npm run test:runner

# ã¾ãŸã¯ç›´æ¥å®Ÿè¡Œ
npx ts-node src/__tests__/test-runner.ts
```

## ğŸ“‹ ãƒ†ã‚¹ãƒˆé–‹ç™ºã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³

### ãƒ¢ãƒƒã‚¯æˆ¦ç•¥
1. **å¤–éƒ¨ä¾å­˜ã‚’å®Œå…¨ãƒ¢ãƒƒã‚¯åŒ–**
   - DynamoDBHelper
   - GoogleTrendsHelper  
   - YahooTrendsHelper

2. **è¨­å®šãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¯ãƒˆãƒªãƒ¼ä½¿ç”¨**
   ```typescript
   const createMockToneSettings = (): ToneSettings => ({ ... });
   ```

3. **æ—¥ä»˜ãƒ¢ãƒƒã‚¯å¯¾å¿œ**
   ```typescript
   jest.spyOn(Date.prototype, 'getDay').mockReturnValue(1); // æœˆæ›œæ—¥
   ```

### ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿è¨­è¨ˆ
```typescript
// å¢ƒç•Œå€¤ãƒ†ã‚¹ãƒˆé‡è¦–
politeness: [0, 39, 40, 69, 70, 79, 80, 100]
mixRatio: [0, 20, 50, 80, 100]
emojiUsage: [0, 19, 20, 39, 40, 69, 70, 100]
```

### ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³è¦³ç‚¹
1. **æ©Ÿèƒ½æ€§**: æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã®ç¢ºèª
2. **å …ç‰¢æ€§**: ã‚¨ãƒ©ãƒ¼æ™‚ã®é©åˆ‡ãªå‡¦ç†
3. **ä»•æ§˜æº–æ‹ **: è¨­è¨ˆæ›¸ãƒ»V1ä»•æ§˜ã¨ã®æ•´åˆæ€§
4. **å“è³ª**: æ–‡å­—åˆ—ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®æ­£ç¢ºæ€§

## ğŸ¯ é‡è¦ãƒ†ã‚¹ãƒˆè¦³ç‚¹

### 1. ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
```typescript
// DynamoDB ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚å®‰å…¨ã«å‹•ä½œ
expect(() => engine.generatePrompt()).not.toThrow();
```

### 2. æ¡ä»¶åˆ†å²ã«ã‚ˆã‚‹å‡ºåŠ›å¤‰åŒ–
```typescript
// ã‚¤ãƒ™ãƒ³ãƒˆãªã— â†’ ã‚»ã‚¯ã‚·ãƒ§ãƒ³éè¡¨ç¤º
expect(result.user).not.toContain('## ä»Šæ—¥ã®ã‚¤ãƒ™ãƒ³ãƒˆ');
```

### 3. ãƒˆãƒ¼ãƒ³å¤‰æ›ç²¾å¯†æ€§
```typescript
// æ•°å€¤ â†’ æ—¥æœ¬èªæ–‡è¨€ã®æ­£ç¢ºæ€§
expect(toneDescription).toContain('éå¸¸ã«ä¸å¯§ã§ç¤¼å„€æ­£ã—ã„æ•¬èª');
```

### 4. ã‚·ã‚¹ãƒ†ãƒ /ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ†é›¢
```typescript
// é©åˆ‡ãªå½¹å‰²åˆ†æ‹…
expect(result.system).toContain('åŸºæœ¬è¦ä»¶');
expect(result.user).toContain('ä»Šæ—¥ã®æ¡ä»¶');
```

## ğŸ”§ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### Jest å‹å®šç¾©ã‚¨ãƒ©ãƒ¼
```bash
npm install --save-dev @types/jest @types/node
```

### ãƒ¢ãƒƒã‚¯é–¢æ•°ã‚¨ãƒ©ãƒ¼
```typescript
// æ­£ã—ã„ãƒ¢ãƒƒã‚¯å½¢å¼
const mockedHelper = Helper as jest.Mocked<typeof Helper>;
mockedHelper.method.mockResolvedValue(mockData);
```

### æ—¥ä»˜é–¢é€£ãƒ†ã‚¹ãƒˆ
```typescript
// å›ºå®šæ—¥ä»˜ã§ã®ãƒ†ã‚¹ãƒˆ
const fixedDate = new Date('2023-11-16');
jest.spyOn(global, 'Date').mockImplementation(() => fixedDate);
```

ã“ã®ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆã«ã‚ˆã‚Šã€PromptEngine ã®å“è³ªã¨ä¿¡é ¼æ€§ã‚’åŒ…æ‹¬çš„ã«ä¿è¨¼ã—ã¾ã™ã€‚