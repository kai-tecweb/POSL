name: ğŸŒ™ Nightly Build & Integration Test

on:
  schedule:
    - cron: '0 2 * * *'  # æ¯æ—¥åˆå‰2æ™‚ï¼ˆJST 11æ™‚ï¼‰ã«å®Ÿè¡Œ
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

env:
  NODE_VERSION: '20'
  AWS_REGION: 'ap-northeast-1'

jobs:
  # ========================
  # ãƒ•ãƒ«çµ±åˆãƒ†ã‚¹ãƒˆ
  # ========================
  full-integration-test:
    name: ğŸ”„ Full Integration Test
    runs-on: ubuntu-latest
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: posl_password
          MYSQL_DATABASE: posl_integration_test
          MYSQL_USER: posl_user
          MYSQL_PASSWORD: posl_password
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3
      
      redis:
        image: redis:7.0
        ports:
          - 6379:6379
        options: --health-cmd="redis-cli ping" --health-interval=10s --health-timeout=5s --health-retries=3
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ğŸ“¦ Install Backend Dependencies
        working-directory: backend
        run: npm ci
      
      - name: ğŸ“¦ Install Frontend Dependencies
        working-directory: frontend
        run: npm ci
      
      # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: ğŸ—„ï¸ Setup Test Database
        run: |
          mysql -h 127.0.0.1 -u posl_user -pposl_password posl_integration_test < infrastructure/mysql-schema.sql
      
      # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰çµ±åˆãƒ†ã‚¹ãƒˆ
      - name: ğŸ§ª Backend Integration Tests
        working-directory: backend
        env:
          NODE_ENV: test
          MYSQL_HOST: localhost
          MYSQL_PORT: 3306
          MYSQL_DATABASE: posl_integration_test
          MYSQL_USER: posl_user
          MYSQL_PASSWORD: posl_password
          REDIS_URL: redis://localhost:6379
        run: |
          npm run test:integration
      
      # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ E2E ãƒ†ã‚¹ãƒˆ
      - name: ğŸ­ Frontend E2E Tests
        working-directory: frontend
        run: |
          npx playwright install
          npm run test:e2e
      
      # ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ
      - name: âš¡ Performance Tests
        working-directory: backend
        env:
          NODE_ENV: test
          MYSQL_HOST: localhost
          MYSQL_PORT: 3306
          MYSQL_DATABASE: posl_integration_test
          MYSQL_USER: posl_user
          MYSQL_PASSWORD: posl_password
        run: |
          npm run test:performance

  # ========================
  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»
  # ========================
  security-audit:
    name: ğŸ”’ Security Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      # ä¾å­˜é–¢ä¿‚è„†å¼±æ€§ãƒã‚§ãƒƒã‚¯
      - name: ğŸ” Backend NPM Audit
        working-directory: backend
        run: npm audit --audit-level moderate
      
      - name: ğŸ” Frontend NPM Audit
        working-directory: frontend
        run: npm audit --audit-level moderate
      
      # é«˜åº¦ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³
      - name: ğŸ›¡ï¸ Snyk Security Scan
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=medium
      
      # ã‚³ãƒ³ãƒ†ãƒŠã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³
      - name: ğŸ³ Container Security Scan
        run: |
          docker build -f backend/Dockerfile.dev -t posl-backend:latest .
          docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
            aquasec/trivy image --exit-code 1 --severity HIGH,CRITICAL posl-backend:latest

  # ========================
  # ä¾å­˜é–¢ä¿‚æ›´æ–°ãƒã‚§ãƒƒã‚¯
  # ========================
  dependency-update:
    name: ğŸ“¦ Dependency Update Check
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ä¾å­˜é–¢ä¿‚ãƒã‚§ãƒƒã‚¯
      - name: ğŸ“Š Backend Outdated Check
        working-directory: backend
        run: |
          npm outdated > backend_outdated.txt || true
          cat backend_outdated.txt
      
      # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ä¾å­˜é–¢ä¿‚ãƒã‚§ãƒƒã‚¯
      - name: ğŸ“Š Frontend Outdated Check
        working-directory: frontend
        run: |
          npm outdated > frontend_outdated.txt || true
          cat frontend_outdated.txt
      
      # è‡ªå‹•PRã‚’ä½œæˆï¼ˆmajorç‰ˆæ›´æ–°ä»¥å¤–ï¼‰
      - name: ğŸ”„ Create Dependency Update PR
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs')
            
            let body = '## ğŸ“¦ é€±æ¬¡ä¾å­˜é–¢ä¿‚æ›´æ–°ãƒ¬ãƒãƒ¼ãƒˆ\n\n'
            
            // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ä¾å­˜é–¢ä¿‚
            if (fs.existsSync('backend_outdated.txt')) {
              const backendOutdated = fs.readFileSync('backend_outdated.txt', 'utf8')
              body += '### ğŸ§ª Backend Dependencies\n\n'
              body += '```\n' + backendOutdated + '\n```\n\n'
            }
            
            // ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ä¾å­˜é–¢ä¿‚  
            if (fs.existsSync('frontend_outdated.txt')) {
              const frontendOutdated = fs.readFileSync('frontend_outdated.txt', 'utf8')
              body += '### ğŸ¨ Frontend Dependencies\n\n'
              body += '```\n' + frontendOutdated + '\n```\n\n'
            }
            
            body += 'è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸãƒ¬ãƒãƒ¼ãƒˆã§ã™ã€‚å¿…è¦ã«å¿œã˜ã¦æ‰‹å‹•ã§æ›´æ–°ã—ã¦ãã ã•ã„ã€‚'
            
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ğŸ“¦ é€±æ¬¡ä¾å­˜é–¢ä¿‚æ›´æ–°ãƒ¬ãƒãƒ¼ãƒˆ',
              body: body,
              labels: ['dependencies', 'maintenance']
            })

  # ========================
  # ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–
  # ========================
  performance-monitoring:
    name: âš¡ Performance Monitoring
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: ğŸ“¦ Install Dependencies
        working-directory: frontend
        run: npm ci
      
      - name: ğŸ—ï¸ Build Frontend
        working-directory: frontend
        run: npm run build
      
      # Lighthouseãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ
      - name: âš¡ Lighthouse Performance Test
        uses: treosh/lighthouse-ci-action@v9
        with:
          configPath: './lighthouserc.json'
          uploadArtifacts: true
          temporaryPublicStorage: true
      
      # Bundle size åˆ†æ
      - name: ğŸ“Š Bundle Size Analysis
        working-directory: frontend
        run: |
          npx bundle-analyzer .next/static/**/*.js

  # ========================
  # ã‚³ãƒ¼ãƒ‰ã‚¯ã‚ªãƒªãƒ†ã‚£ç›£è¦–
  # ========================
  code-quality:
    name: ğŸ“Š Code Quality Monitoring
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # SonarQubeç”¨ã«å…¨å±¥æ­´å–å¾—
      
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      # SonarQubeåˆ†æ
      - name: ğŸ“Š SonarQube Scan
        uses: sonarqube-quality-gate-action@master
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          scanMetadataReportFile: target/sonar/report-task.txt

  # ========================
  # çµæœã‚µãƒãƒªãƒ¼
  # ========================
  nightly-summary:
    name: ğŸ“‹ Nightly Build Summary
    runs-on: ubuntu-latest
    needs: [full-integration-test, security-audit, dependency-update, performance-monitoring, code-quality]
    if: always()
    
    steps:
      - name: ğŸ“Š Generate Summary Report
        uses: actions/github-script@v6
        with:
          script: |
            const results = {
              integration: '${{ needs.full-integration-test.result }}',
              security: '${{ needs.security-audit.result }}',
              dependencies: '${{ needs.dependency-update.result }}',
              performance: '${{ needs.performance-monitoring.result }}',
              quality: '${{ needs.code-quality.result }}'
            }
            
            const passed = Object.values(results).filter(r => r === 'success').length
            const failed = Object.values(results).filter(r => r === 'failure').length
            const total = Object.keys(results).length
            
            const summary = `## ğŸŒ™ Nightly Build Summary
            
            **Date:** ${new Date().toISOString().split('T')[0]}
            **Status:** ${failed === 0 ? 'âœ… All Passed' : 'âŒ Issues Found'}
            
            ### ğŸ“Š Results
            - âœ… Passed: ${passed}/${total}
            - âŒ Failed: ${failed}/${total}
            
            ### ğŸ“‹ Details
            ${Object.entries(results).map(([job, result]) => 
              `- ${result === 'success' ? 'âœ…' : result === 'failure' ? 'âŒ' : 'â­ï¸'} ${job}: ${result}`
            ).join('\n')}
            
            ${failed > 0 ? 'âš ï¸ **Action Required:** å¤±æ•—ã—ãŸãƒã‚§ãƒƒã‚¯é …ç›®ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚' : 'ğŸ‰ **All Good:** ã™ã¹ã¦ã®ãƒã‚§ãƒƒã‚¯ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸï¼'}
            `
            
            // Slackã«é€šçŸ¥
            const webhook = '${{ secrets.SLACK_WEBHOOK_URL }}'
            if (webhook) {
              await fetch(webhook, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  text: `ğŸŒ™ POSL Nightly Build: ${failed === 0 ? 'âœ… Success' : 'âŒ Issues Found'}`,
                  blocks: [{
                    type: 'section',
                    text: { type: 'mrkdwn', text: summary }
                  }]
                })
              })
            }