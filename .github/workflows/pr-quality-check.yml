name: ğŸ” Pull Request Quality Check

on:
  pull_request:
    types: [opened, synchronize, reopened]

env:
  NODE_VERSION: '20'

jobs:
  # ========================
  # PRå“è³ªãƒã‚§ãƒƒã‚¯
  # ========================
  pr-quality-check:
    name: ğŸ“‹ Pull Request Quality Check
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å…¨å±¥æ­´ã‚’å–å¾—ã—ã¦diffã‚’æ­£ç¢ºã«è¨ˆç®—
      
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      # ãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›´åˆ†æ
      - name: ğŸ“Š Analyze Changed Files
        id: changes
        uses: dorny/paths-filter@v2
        with:
          filters: |
            backend:
              - 'backend/**'
            frontend:
              - 'frontend/**'
            terraform:
              - 'terraform/**'
            docs:
              - 'ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ/**'
              - '*.md'
      
      # PRã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯
      - name: ğŸ“ Check PR Size
        uses: codacy/git-version@2.7.1
        id: pr-size
      
      - name: ğŸ’¬ Comment PR Size
        if: steps.pr-size.outputs.additions > 500
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âš ï¸ **Large PR Alert**: ã“ã®PRã¯500è¡Œä»¥ä¸Šã®å¤‰æ›´ã‚’å«ã‚“ã§ã„ã¾ã™ã€‚ãƒ¬ãƒ“ãƒ¥ãƒ¼åŠ¹ç‡ã®ãŸã‚ã«åˆ†å‰²ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚'
            })

  # ========================
  # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å¤‰æ›´ãƒã‚§ãƒƒã‚¯
  # ========================
  backend-check:
    name: ğŸ§ª Backend Changes Check
    runs-on: ubuntu-latest
    needs: pr-quality-check
    if: needs.pr-quality-check.outputs.backend == 'true'
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: posl_password
          MYSQL_DATABASE: posl_test_db
          MYSQL_USER: posl_user
          MYSQL_PASSWORD: posl_password
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json
      
      - name: ğŸ“¦ Install Dependencies
        working-directory: backend
        run: npm ci
      
      - name: ğŸ” TypeScript Check
        working-directory: backend
        run: npm run type-check
      
      - name: ğŸ“ Lint Check
        working-directory: backend
        run: npm run lint
      
      - name: ğŸ§ª Run Tests
        working-directory: backend
        env:
          NODE_ENV: test
          MYSQL_HOST: localhost
          MYSQL_PORT: 3306
          MYSQL_DATABASE: posl_test_db
          MYSQL_USER: posl_user
          MYSQL_PASSWORD: posl_password
        run: npm run test:coverage
      
      - name: ğŸ“Š Coverage Report Comment
        uses: romeovs/lcov-reporter-action@v0.3.1
        with:
          lcov-file: backend/coverage/lcov.info
          github-token: ${{ secrets.GITHUB_TOKEN }}
          title: "Backend Test Coverage Report"

  # ========================
  # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å¤‰æ›´ãƒã‚§ãƒƒã‚¯
  # ========================
  frontend-check:
    name: ğŸ¨ Frontend Changes Check
    runs-on: ubuntu-latest
    needs: pr-quality-check
    if: needs.pr-quality-check.outputs.frontend == 'true'
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: ğŸ“¦ Install Dependencies
        working-directory: frontend
        run: npm ci
      
      - name: ğŸ” TypeScript Check
        working-directory: frontend
        run: npm run type-check
      
      - name: ğŸ“ Lint Check
        working-directory: frontend
        run: npm run lint
      
      - name: ğŸ¨ Format Check
        working-directory: frontend
        run: npm run format:check
      
      - name: ğŸ—ï¸ Build Test
        working-directory: frontend
        run: npm run build

  # ========================
  # ã‚¤ãƒ³ãƒ•ãƒ©å¤‰æ›´ãƒã‚§ãƒƒã‚¯
  # ========================
  terraform-check:
    name: ğŸ—ï¸ Terraform Changes Check
    runs-on: ubuntu-latest
    needs: pr-quality-check
    if: needs.pr-quality-check.outputs.terraform == 'true'
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: latest
      
      - name: ğŸ“‹ Terraform Format Check
        working-directory: terraform/environments/production
        run: terraform fmt -check -recursive
      
      - name: ğŸ”§ Terraform Init
        working-directory: terraform/environments/production
        run: terraform init
      
      - name: âœ… Terraform Validate
        working-directory: terraform/environments/production
        run: terraform validate
      
      - name: ğŸ“‹ Terraform Plan
        working-directory: terraform/environments/production
        run: terraform plan -no-color > plan.txt
        continue-on-error: true
      
      - name: ğŸ’¬ Comment Terraform Plan
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs')
            const plan = fs.readFileSync('terraform/environments/production/plan.txt', 'utf8')
            
            const output = `### ğŸ—ï¸ Terraform Plan Results
            
            <details><summary>Show Plan</summary>
            
            \`\`\`
            ${plan}
            \`\`\`
            
            </details>`
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            })

  # ========================
  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯
  # ========================
  security-check:
    name: ğŸ”’ Security Check
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ğŸ”’ Dependency Vulnerability Scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'table'
      
      - name: ğŸ” Secret Scan
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD

  # ========================
  # PRãƒãƒ¼ã‚¸å¯èƒ½æ€§ãƒã‚§ãƒƒã‚¯
  # ========================
  merge-ready:
    name: âœ… Merge Ready Check
    runs-on: ubuntu-latest
    needs: [backend-check, frontend-check, terraform-check, security-check]
    if: always()
    
    steps:
      - name: ğŸ¯ Check All Jobs Status
        uses: actions/github-script@v6
        with:
          script: |
            const jobs = [
              '${{ needs.backend-check.result }}',
              '${{ needs.frontend-check.result }}', 
              '${{ needs.terraform-check.result }}',
              '${{ needs.security-check.result }}'
            ]
            
            const failed = jobs.filter(result => result === 'failure')
            const skipped = jobs.filter(result => result === 'skipped')
            
            if (failed.length > 0) {
              core.setFailed(`âŒ ${failed.length} job(s) failed`)
              return
            }
            
            const message = `âœ… **Merge Ready!** All quality checks passed.
            
            ğŸ“Š **Summary:**
            - âœ… Passed: ${jobs.length - failed.length - skipped.length} jobs
            - â­ï¸ Skipped: ${skipped.length} jobs
            - âŒ Failed: ${failed.length} jobs
            
            ã“ã®PRã¯ãƒãƒ¼ã‚¸æº–å‚™ãŒã§ãã¦ã„ã¾ã™ï¼ğŸ‰`
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            })