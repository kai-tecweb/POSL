name: ğŸš€ POSL CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  NODE_VERSION: '20'
  AWS_REGION: 'ap-northeast-1'

jobs:
  # ========================
  # 1. ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆ
  # ========================
  backend-test:
    name: ğŸ§ª Backend Test & Lint
    runs-on: ubuntu-latest
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: posl_password
          MYSQL_DATABASE: posl_test_db
          MYSQL_USER: posl_user
          MYSQL_PASSWORD: posl_password
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json
      
      - name: ğŸ“¦ Install Backend Dependencies
        working-directory: backend
        run: npm ci
      
      - name: ğŸ” TypeScript Type Check
        working-directory: backend
        run: npm run type-check
      
      - name: ğŸ“ Lint Check
        working-directory: backend
        run: npm run lint
      
      - name: ğŸ§ª Run Tests with Coverage
        working-directory: backend
        env:
          NODE_ENV: test
          MYSQL_HOST: localhost
          MYSQL_PORT: 3306
          MYSQL_DATABASE: posl_test_db
          MYSQL_USER: posl_user
          MYSQL_PASSWORD: posl_password
        run: npm run test:coverage
      
      - name: ğŸ“Š Upload Coverage Reports
        uses: codecov/codecov-action@v3
        with:
          file: backend/coverage/lcov.info
          flags: backend
          name: backend-coverage

  # ========================
  # 2. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆ
  # ========================
  frontend-test:
    name: ğŸ¨ Frontend Test & Build
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: ğŸ“¦ Install Frontend Dependencies
        working-directory: frontend
        run: npm ci
      
      - name: ğŸ” TypeScript Type Check
        working-directory: frontend
        run: npm run type-check
      
      - name: ğŸ“ Lint Check
        working-directory: frontend
        run: npm run lint
      
      - name: ğŸ¨ Prettier Format Check
        working-directory: frontend
        run: npm run format:check
      
      - name: ğŸ—ï¸ Build Frontend
        working-directory: frontend
        env:
          NODE_ENV: production
        run: npm run build

  # ========================
  # 3. ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£æ¤œè¨¼
  # ========================
  infrastructure-validate:
    name: ğŸ—ï¸ Terraform Validate
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: latest
      
      - name: ğŸ”§ Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: ğŸ“‹ Terraform Format Check
        working-directory: terraform/environments/production
        run: terraform fmt -check -recursive
      
      - name: ğŸ”§ Terraform Init
        working-directory: terraform/environments/production
        run: terraform init
      
      - name: âœ… Terraform Validate
        working-directory: terraform/environments/production
        run: terraform validate
      
      - name: ğŸ“‹ Terraform Plan
        working-directory: terraform/environments/production
        run: terraform plan -no-color
        continue-on-error: true

  # ========================
  # 4. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³
  # ========================
  security-scan:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    needs: [backend-test, frontend-test]
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ğŸ”’ Run Trivy Vulnerability Scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
      
      - name: ğŸ“Š Upload Trivy Scan Results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'

  # ========================
  # 5. é–‹ç™ºç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤ (developãƒ–ãƒ©ãƒ³ãƒ)
  # ========================
  deploy-dev:
    name: ğŸš€ Deploy to Development
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    needs: [backend-test, frontend-test, infrastructure-validate, security-scan]
    environment: development
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ğŸ”§ Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: ğŸ“¦ Install Serverless Framework
        run: npm install -g serverless
      
      - name: ğŸ“¦ Install Backend Dependencies
        working-directory: backend
        run: npm ci
      
      - name: ğŸš€ Deploy Backend to Dev
        working-directory: backend
        env:
          STAGE: dev
        run: npm run deploy:dev
      
      - name: ğŸ“¦ Install Frontend Dependencies
        working-directory: frontend
        run: npm ci
      
      - name: ğŸ—ï¸ Build Frontend
        working-directory: frontend
        env:
          NODE_ENV: production
          NEXT_PUBLIC_API_URL: ${{ secrets.DEV_API_URL }}
        run: npm run build
      
      - name: ğŸ“¤ Deploy Frontend to S3
        working-directory: frontend
        run: |
          aws s3 sync out/ s3://${{ secrets.DEV_S3_BUCKET }} --delete
          aws cloudfront create-invalidation --distribution-id ${{ secrets.DEV_CLOUDFRONT_ID }} --paths "/*"

  # ========================
  # 6. æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤ (mainãƒ–ãƒ©ãƒ³ãƒ)
  # ========================
  deploy-prod:
    name: ğŸŒŸ Deploy to Production
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    needs: [backend-test, frontend-test, infrastructure-validate, security-scan]
    environment: production
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ğŸ”§ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: latest
      
      - name: ğŸ”§ Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      # ã‚¤ãƒ³ãƒ•ãƒ©æ›´æ–°
      - name: ğŸ—ï¸ Deploy Infrastructure
        working-directory: terraform/environments/production
        run: |
          terraform init
          terraform apply -auto-approve
      
      # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ‡ãƒ—ãƒ­ã‚¤
      - name: ğŸ“¦ Install Serverless Framework
        run: npm install -g serverless
      
      - name: ğŸ“¦ Install Backend Dependencies
        working-directory: backend
        run: npm ci
      
      - name: ğŸš€ Deploy Backend to Production
        working-directory: backend
        env:
          STAGE: prod
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          TWITTER_API_KEY: ${{ secrets.TWITTER_API_KEY }}
          TWITTER_API_SECRET: ${{ secrets.TWITTER_API_SECRET }}
          TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          TWITTER_ACCESS_TOKEN_SECRET: ${{ secrets.TWITTER_ACCESS_TOKEN_SECRET }}
        run: npm run deploy:prod
      
      # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ‡ãƒ—ãƒ­ã‚¤
      - name: ğŸ“¦ Install Frontend Dependencies
        working-directory: frontend
        run: npm ci
      
      - name: ğŸ—ï¸ Build Frontend for Production
        working-directory: frontend
        env:
          NODE_ENV: production
          NEXT_PUBLIC_API_URL: ${{ secrets.PROD_API_URL }}
        run: npm run build
      
      # EC2ã¸ã®ç›´æ¥ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆç¾åœ¨ã®ã‚µãƒ¼ãƒãƒ¼æ§‹æˆç”¨ï¼‰
      - name: ğŸ”‘ Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts || true
      
      - name: ğŸ“¤ Deploy to EC2 via SSH
        run: |
          # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚’ã‚µãƒ¼ãƒãƒ¼ã«åŒæœŸ
          rsync -avz --delete \
            -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
            frontend/ ubuntu@${{ secrets.EC2_HOST }}:/home/ubuntu/POSL-repo/frontend/
          
          # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚’ã‚µãƒ¼ãƒãƒ¼ã«åŒæœŸ
          rsync -avz --delete \
            -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
            backend/ ubuntu@${{ secrets.EC2_HOST }}:/home/ubuntu/POSL-repo/backend/
      
      - name: ğŸš€ Restart Application on EC2
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ubuntu@${{ secrets.EC2_HOST }} << 'EOF'
            set -e
            cd /home/ubuntu/POSL-repo/frontend
            npm ci --production
            npm run build
            pm2 restart posl-frontend || pm2 start npm --name "posl-frontend" -- start
            
            cd /home/ubuntu/POSL-repo/backend
            # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®å†èµ·å‹•ï¼ˆserverless offlineãŒå®Ÿè¡Œä¸­ã®å ´åˆã¯å†èµ·å‹•ï¼‰
            if pgrep -f "serverless offline" > /dev/null; then
              pkill -f "serverless offline" || true
              sleep 2
            fi
            cd /home/ubuntu/POSL-repo/backend
            nohup npm exec serverless offline --stage dev --host 0.0.0.0 --httpPort 3001 > /dev/null 2>&1 &
          EOF
      
      # S3ã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆå°†æ¥ã®CloudFrontæ§‹æˆç”¨ã€ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
      - name: ğŸ“¤ Deploy Frontend to Production S3 (Optional)
        if: ${{ secrets.PROD_S3_BUCKET != '' }}
        working-directory: frontend
        run: |
          aws s3 sync out/ s3://${{ secrets.PROD_S3_BUCKET }} --delete
          if [ -n "${{ secrets.PROD_CLOUDFRONT_ID }}" ]; then
            aws cloudfront create-invalidation --distribution-id ${{ secrets.PROD_CLOUDFRONT_ID }} --paths "/*"
          fi
      
      # ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†é€šçŸ¥
      - name: ğŸ“¢ Deploy Success Notification
        uses: 8398a7/action-slack@v3
        with:
          status: success
          channel: '#posl-deployment'
          text: 'ğŸ‰ POSLæœ¬ç•ªç’°å¢ƒã¸ã®è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã—ã¾ã—ãŸï¼'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  # ========================
  # 7. ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
  # ========================
  health-check:
    name: ğŸ©º Health Check
    runs-on: ubuntu-latest
    needs: [deploy-prod]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: ğŸ©º Backend Health Check
        run: |
          echo "Waiting for deployment to stabilize..."
          sleep 30
          curl -f ${{ secrets.PROD_API_URL }}/health || exit 1
      
      - name: ğŸ©º Frontend Health Check
        run: |
          curl -f ${{ secrets.PROD_FRONTEND_URL }} || exit 1
      
      - name: ğŸ“¢ Health Check Success
        uses: 8398a7/action-slack@v3
        with:
          status: success
          channel: '#posl-deployment'
          text: 'âœ… POSLæœ¬ç•ªç’°å¢ƒã®ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ãŒæ­£å¸¸å®Œäº†ã—ã¾ã—ãŸï¼'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  # ========================
  # 8. å¤±æ•—æ™‚ã®ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
  # ========================
  rollback:
    name: ğŸ”„ Rollback on Failure
    runs-on: ubuntu-latest
    if: failure()
    needs: [deploy-prod, health-check]
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: ğŸ”„ Rollback Backend
        working-directory: backend
        run: |
          npm install -g serverless
          serverless rollback --stage prod
      
      - name: ğŸ“¢ Rollback Notification
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          channel: '#posl-deployment'
          text: 'ğŸš¨ POSLæœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤ãŒå¤±æ•—ã—ã€è‡ªå‹•ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’å®Ÿè¡Œã—ã¾ã—ãŸã€‚'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}