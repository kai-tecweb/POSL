# HTTPS要件についての説明

**作成日**: 2025年11月20日  
**目的**: マイクアクセスにHTTPSが必要な理由と、HTTP接続での対応方法を説明

## 🔒 なぜHTTPSが必要なのか

### ブラウザのセキュリティポリシー

`getUserMedia` API（マイク・カメラアクセス）は、**セキュリティ上の理由からHTTPS接続（またはlocalhost）でのみ動作する**というのが、現代のブラウザの標準的な動作です。

**理由**:
1. **プライバシー保護**: マイクやカメラは個人情報を含むセンシティブなデバイス
2. **中間者攻撃の防止**: HTTP接続では通信が暗号化されていないため、盗聴のリスクがある
3. **悪意のあるサイトからの保護**: ユーザーが意図しないマイクアクセスを防ぐ

### 例外: localhost

開発環境では、`localhost` や `127.0.0.1` へのアクセスは「安全なコンテキスト」として扱われ、HTTP接続でもマイクアクセスが許可されます。

## 🌐 現在の環境

### 本番環境の状況

- **URL**: `http://18.179.104.143/` (HTTP接続)
- **SSL証明書**: 未設定
- **録音機能**: HTTP接続のため制限される

### HTTP接続でも動作する機能

✅ **ファイルアップロード機能**: HTTP接続でも完全に動作します
- 音声ファイルを選択してアップロード
- OpenAI Whisper APIによる転写
- プロファイル自動更新

❌ **直接録音機能**: HTTP接続では制限される
- ブラウザのセキュリティポリシーにより制限
- 一部のブラウザでは動作する可能性もあるが、推奨されない

## 💡 解決方法

### オプション1: HTTPS化（推奨）

**メリット**:
- 録音機能が完全に利用可能
- セキュリティが向上
- ユーザー信頼性が向上

**実装方法**:
1. **Let's Encryptを使用**（無料）
   ```bash
   # Certbotインストール
   sudo apt install certbot python3-certbot-nginx
   
   # SSL証明書取得（ドメイン名が必要）
   sudo certbot --nginx -d your-domain.com
   ```

2. **注意点**:
   - ドメイン名が必要（IPアドレスだけでは証明書を取得できない）
   - ドメインを取得してDNS設定が必要

### オプション2: HTTP接続のまま（現在の状態）

**メリット**:
- 追加設定不要
- ファイルアップロード機能で十分

**制限**:
- 直接録音機能は利用できない
- セキュリティリスク（通信が暗号化されない）

### オプション3: ブラウザ設定で許可（非推奨）

一部のブラウザでは、HTTP接続でもマイクアクセスを許可する設定がありますが、**セキュリティ上の理由から推奨されません**。

## 📊 実装状況

### 現在の実装

1. **HTTP接続チェック**: 接続方式を自動検出
2. **条件付きUI**: HTTP接続時は録音機能を無効化
3. **ファイルアップロード推奨**: HTTP接続時はファイルアップロードを推奨

### 動作確認

- ✅ HTTP接続: ファイルアップロード機能が動作
- ❌ HTTP接続: 直接録音機能は制限される
- ✅ HTTPS接続: すべての機能が動作（マイク権限が必要）

## 🎯 推奨事項

### 短期対応（現在）

**ファイルアップロード機能を使用**
- HTTP接続でも完全に動作
- 録音機能と同等の機能を提供
- セキュリティリスクなし

### 長期対応（将来）

**HTTPS化を検討**
- ドメイン名を取得
- Let's EncryptでSSL証明書を取得
- Nginx設定を更新

## 📝 まとめ

- **HTTPSが必要な理由**: ブラウザのセキュリティポリシー（プライバシー保護）
- **現在の環境**: HTTP接続のため、録音機能は制限される
- **代替手段**: ファイルアップロード機能が利用可能
- **将来の対応**: HTTPS化を検討（ドメイン名が必要）

---

**結論**: HTTP接続でも、ファイルアップロード機能を使用することで、音声日記機能は完全に利用できます。直接録音機能が必要な場合は、HTTPS化（ドメイン名の取得が必要）を検討してください。

