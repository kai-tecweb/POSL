# ðŸš€ POSL CI/CD ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³è¨­è¨ˆæ›¸

## ðŸ“‹ æ¦‚è¦

POSLãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å®Œå…¨è‡ªå‹•åŒ–ã•ã‚ŒãŸCI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã§ã™ã€‚ãƒ†ã‚¹ãƒˆâ†’ãƒ“ãƒ«ãƒ‰â†’ãƒ‡ãƒ—ãƒ­ã‚¤ã®å…¨ãƒ—ãƒ­ã‚»ã‚¹ã‚’è‡ªå‹•åŒ–ã—ã€é«˜å“è³ªãªã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã®ç¶™ç¶šçš„ãƒ‡ãƒªãƒãƒªãƒ¼ã‚’å®Ÿç¾ã—ã¾ã™ã€‚

## ðŸ—ï¸ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³æ§‹æˆ

```mermaid
graph TB
    A[ã‚³ãƒ¼ãƒ‰å¤‰æ›´] --> B[GitHub Actions Trigger]
    B --> C{ãƒ–ãƒ©ãƒ³ãƒåˆ¤å®š}
    
    C -->|PR| D[PR Quality Check]
    C -->|develop| E[Development Pipeline]
    C -->|main| F[Production Pipeline]
    C -->|schedule| G[Nightly Build]
    
    D --> H[ãƒ†ã‚¹ãƒˆ & Lint]
    D --> I[ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³]
    D --> J[ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼æ”¯æ´]
    
    E --> K[ãƒ†ã‚¹ãƒˆ & ãƒ“ãƒ«ãƒ‰]
    E --> L[é–‹ç™ºç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤]
    E --> M[çµ±åˆãƒ†ã‚¹ãƒˆ]
    
    F --> N[ãƒ•ãƒ«ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ]
    F --> O[ã‚¤ãƒ³ãƒ•ãƒ©ãƒ‡ãƒ—ãƒ­ã‚¤]
    F --> P[æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤]
    F --> Q[ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯]
    F --> R{æˆåŠŸ?}
    R -->|Yes| S[é€šçŸ¥]
    R -->|No| T[è‡ªå‹•ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯]
    
    G --> U[çµ±åˆãƒ†ã‚¹ãƒˆ]
    G --> V[ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»]
    G --> W[ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ç›£è¦–]
```

## ðŸ“ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«

### 1. ãƒ¡ã‚¤ãƒ³CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ (`ci-cd-pipeline.yml`)

**ãƒˆãƒªã‚¬ãƒ¼:**
- `main`ãƒ–ãƒ©ãƒ³ãƒã¸ã®push â†’ æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤
- `develop`ãƒ–ãƒ©ãƒ³ãƒã¸ã®push â†’ é–‹ç™ºç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤
- Pull Requestã®ä½œæˆãƒ»æ›´æ–°

**ã‚¸ãƒ§ãƒ–æ§‹æˆ:**

#### ðŸ§ª ãƒ†ã‚¹ãƒˆãƒ•ã‚§ãƒ¼ã‚º
- **Backend Test**: TypeScriptåž‹ãƒã‚§ãƒƒã‚¯ã€Lintã€Jestå˜ä½“ãƒ†ã‚¹ãƒˆ (MySQLä»˜ã)
- **Frontend Test**: TypeScriptåž‹ãƒã‚§ãƒƒã‚¯ã€Lintã€Next.js ãƒ“ãƒ«ãƒ‰
- **Infrastructure Validate**: Terraformæ¤œè¨¼ã¨ãƒ—ãƒ©ãƒ³å®Ÿè¡Œ

#### ðŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ•ã‚§ãƒ¼ã‚º
- **Security Scan**: Trivyã«ã‚ˆã‚‹è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³

#### ðŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ•ã‚§ãƒ¼ã‚º
- **Development Deploy**: é–‹ç™ºç’°å¢ƒã¸ã®è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤
- **Production Deploy**: æœ¬ç•ªç’°å¢ƒã¸ã®è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆã‚¤ãƒ³ãƒ•ãƒ© â†’ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ â†’ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ï¼‰

#### ðŸ©º æ¤œè¨¼ãƒ•ã‚§ãƒ¼ã‚º
- **Health Check**: ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã®ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
- **Rollback**: å¤±æ•—æ™‚ã®è‡ªå‹•ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯

### 2. PRå“è³ªãƒã‚§ãƒƒã‚¯ (`pr-quality-check.yml`)

**ç›®çš„:** Pull Requestã®å“è³ªã‚’è‡ªå‹•æ¤œè¨¼

**ä¸»ãªæ©Ÿèƒ½:**
- å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ã®è‡ªå‹•åˆ†æž
- PRã‚µã‚¤ã‚ºã®è­¦å‘Šï¼ˆ500è¡Œä»¥ä¸Šï¼‰
- å¤‰æ›´å†…å®¹ã«å¿œã˜ãŸé¸æŠžçš„ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
- ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆ
- Terraformãƒ—ãƒ©ãƒ³çµæžœã®è‡ªå‹•ã‚³ãƒ¡ãƒ³ãƒˆ
- ãƒžãƒ¼ã‚¸å¯èƒ½æ€§åˆ¤å®š

### 3. å¤œé–“ãƒ“ãƒ«ãƒ‰ (`nightly-build.yml`)

**ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«:** æ¯Žæ—¥åˆå‰2æ™‚ï¼ˆJST 11æ™‚ï¼‰

**å®Ÿè¡Œå†…å®¹:**
- ãƒ•ãƒ«çµ±åˆãƒ†ã‚¹ãƒˆï¼ˆMySQL + Redisï¼‰
- E2Eãƒ†ã‚¹ãƒˆï¼ˆPlaywrightï¼‰
- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»
- ä¾å­˜é–¢ä¿‚æ›´æ–°ãƒã‚§ãƒƒã‚¯
- ã‚³ãƒ¼ãƒ‰å“è³ªç›£è¦–ï¼ˆSonarQubeï¼‰
- åŒ…æ‹¬çš„ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ

## âš™ï¸ ç’°å¢ƒè¨­å®š

### GitHub Secrets

æœ¬ç•ªç’°å¢ƒã§å¿…è¦ãªã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ:

```bash
# AWSè¨­å®š
AWS_ACCESS_KEY_ID
AWS_SECRET_ACCESS_KEY

# APIè¨­å®š
OPENAI_API_KEY
TWITTER_API_KEY
TWITTER_API_SECRET  
TWITTER_ACCESS_TOKEN
TWITTER_ACCESS_TOKEN_SECRET

# ç’°å¢ƒURL
PROD_API_URL
PROD_FRONTEND_URL
DEV_API_URL

# S3è¨­å®š
PROD_S3_BUCKET
DEV_S3_BUCKET
PROD_CLOUDFRONT_ID
DEV_CLOUDFRONT_ID

# é€šçŸ¥è¨­å®š
SLACK_WEBHOOK_URL

# å“è³ªç›£è¦–
SNYK_TOKEN
SONAR_TOKEN
```

### GitHub Environments

#### Development Environment
- **Protection rules**: ãªã—ï¼ˆè‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ï¼‰
- **Variables**: é–‹ç™ºç’°å¢ƒå›ºæœ‰ã®è¨­å®šå€¤

#### Production Environment  
- **Protection rules**: 
  - Required reviewers: 1äººä»¥ä¸Š
  - Wait timer: 5åˆ†
  - Required branches: `main`ã®ã¿
- **Variables**: æœ¬ç•ªç’°å¢ƒå›ºæœ‰ã®è¨­å®šå€¤

## ðŸŽ¯ ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ•ãƒ­ãƒ¼

### é–‹ç™ºç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤ (`develop`ãƒ–ãƒ©ãƒ³ãƒ)

1. **Trigger**: `develop`ãƒ–ãƒ©ãƒ³ãƒã¸ã®push
2. **Tests**: å…¨ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ
3. **Deploy**: 
   - Backend â†’ Serverless Framework (dev stage)
   - Frontend â†’ S3 + CloudFront
4. **Notification**: Slacké€šçŸ¥

### æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤ (`main`ãƒ–ãƒ©ãƒ³ãƒ)

1. **Trigger**: `main`ãƒ–ãƒ©ãƒ³ãƒã¸ã®push
2. **Full Testing**: ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆã‚’å®Ÿè¡Œ
3. **Infrastructure**: Terraform apply
4. **Backend Deploy**: Serverless Framework (prod stage)  
5. **Frontend Deploy**: S3 + CloudFront
6. **Health Check**: API/ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ç¨¼åƒç¢ºèª
7. **Success**: Slacké€šçŸ¥
8. **Failure**: è‡ªå‹•ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ + ã‚¢ãƒ©ãƒ¼ãƒˆ

## ðŸ“Š å“è³ªã‚²ãƒ¼ãƒˆ

### å¿…é ˆæ¡ä»¶
- [ ] å…¨ãƒ†ã‚¹ãƒˆã®ãƒ‘ã‚¹ï¼ˆå˜ä½“ãƒ»çµ±åˆãƒ»E2Eï¼‰
- [ ] TypeScriptåž‹ãƒã‚§ãƒƒã‚¯é€šéŽ
- [ ] ESLint/Prettier ãƒã‚§ãƒƒã‚¯é€šéŽ
- [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³é€šéŽ
- [ ] Terraformãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³é€šéŽ

### æŽ¨å¥¨æ¡ä»¶
- [ ] ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ > 80%
- [ ] PRã‚µã‚¤ã‚º < 500è¡Œ
- [ ] å®Ÿè¡Œæ™‚é–“ < 15åˆ†
- [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ãªã—

## ðŸ”” é€šçŸ¥ã¨ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°

### Slackçµ±åˆ
- ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸ/å¤±æ•—ã®é€šçŸ¥
- ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯çµæžœ
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ©ãƒ¼ãƒˆ
- å¤œé–“ãƒ“ãƒ«ãƒ‰çµæžœã‚µãƒžãƒªãƒ¼

### ãƒ¡ãƒˆãƒªã‚¯ã‚¹
- ãƒ“ãƒ«ãƒ‰æˆåŠŸçŽ‡
- ãƒ‡ãƒ—ãƒ­ã‚¤é »åº¦
- å¹³å‡ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚é–“
- ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯é »åº¦

## ðŸ› ï¸ ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºã‚µãƒãƒ¼ãƒˆ

### Pre-commit Hooks

```bash
# ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
npm install -g pre-commit

# è¨­å®š
cat > .pre-commit-config.yaml << 'EOF'
repos:
  - repo: local
    hooks:
      - id: backend-lint
        name: Backend Lint
        entry: npm run lint
        language: system
        files: backend/src/.*\.(ts|js)$
        
      - id: frontend-lint  
        name: Frontend Lint
        entry: npm run lint
        language: system
        files: frontend/src/.*\.(ts|tsx|js|jsx)$
        
      - id: terraform-fmt
        name: Terraform Format
        entry: terraform fmt -check
        language: system
        files: terraform/.*\.tf$
EOF
```

### ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ

```bash
# ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆï¼ˆDockerä½¿ç”¨ï¼‰
cd backend
docker-compose -f ../docker-compose.yml up -d mysql
npm test

# ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆ
cd frontend  
npm run type-check
npm run lint
npm run build

# ã‚¤ãƒ³ãƒ•ãƒ©ãƒ†ã‚¹ãƒˆ
cd terraform/environments/production
terraform init
terraform validate
terraform plan
```

## ðŸš€ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹æœ€é©åŒ–

### ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³é«˜é€ŸåŒ–
- **ä¸¦åˆ—å®Ÿè¡Œ**: ç‹¬ç«‹ã—ãŸã‚¸ãƒ§ãƒ–ã®åŒæ™‚å®Ÿè¡Œ
- **ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ´»ç”¨**: npmã€Terraformã€Dockerå±¤ã‚­ãƒ£ãƒƒã‚·ãƒ¥
- **æ¡ä»¶åˆ†å²**: å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ã«å¿œã˜ãŸé¸æŠžå®Ÿè¡Œ
- **ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ã‚¿ãƒ«ãƒ“ãƒ«ãƒ‰**: Next.jsã‚­ãƒ£ãƒƒã‚·ãƒ¥æ´»ç”¨

### ãƒªã‚½ãƒ¼ã‚¹åŠ¹çŽ‡åŒ–
- **é©åˆ‡ãªãƒ©ãƒ³ãƒŠãƒ¼**: ubuntu-latestã§çµ±ä¸€
- **ã‚µãƒ¼ãƒ“ã‚¹ã‚³ãƒ³ãƒ†ãƒŠ**: MySQLãƒ†ã‚¹ãƒˆç”¨
- **ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š**: é•·æ™‚é–“å®Ÿè¡Œã®é˜²æ­¢

## ðŸ“ˆ ç¶™ç¶šçš„æ”¹å–„

### ãƒ¡ãƒˆãƒªã‚¯ã‚¹ç›£è¦–
- GitHub Actions Insightsæ´»ç”¨
- å®Ÿè¡Œæ™‚é–“ã®è¿½è·¡
- æˆåŠŸçŽ‡ã®ç›£è¦–
- ã‚³ã‚¹ãƒˆåˆ†æž

### å®šæœŸãƒ¬ãƒ“ãƒ¥ãƒ¼é …ç›®
- [ ] ä¾å­˜é–¢ä¿‚ã®æ›´æ–°
- [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šã®è¦‹ç›´ã—  
- [ ] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ã®æœ€é©åŒ–
- [ ] æ–°æ©Ÿèƒ½ã¸ã®å¯¾å¿œ

---

ã“ã®CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã«ã‚ˆã‚Šã€POSLãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯é«˜å“è³ªã§å®‰å…¨ãªç¶™ç¶šçš„ãƒ‡ãƒªãƒãƒªãƒ¼ã‚’å®Ÿç¾ã—ã€é–‹ç™ºåŠ¹çŽ‡ã®å¤§å¹…ãªå‘ä¸Šã‚’å®Ÿç¾ã—ã¾ã™ã€‚