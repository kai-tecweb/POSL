# 本番環境移行 完全版ドキュメント

**作成日**: 2025年11月20日  
**目的**: 本番環境への完全移行の経緯と現在のアーキテクチャを正確に記録

## 📋 移行の経緯

### 以前のアーキテクチャ（Lambda関数ベース）

**期間**: 初期開発～2025年11月中旬

- **バックエンド**: AWS Lambda関数（Serverless Framework）
- **データベース**: DynamoDB → MySQL（移行途中）
- **デプロイ**: Serverless Framework経由
- **問題点**:
  - Lambda関数のコールドスタート
  - 開発環境と本番環境の不一致
  - ローカル開発の複雑さ

### 現在のアーキテクチャ（Express.jsベース）

**期間**: 2025年11月中旬～現在

- **バックエンド**: Express.js（`simple_final_api.js`）
- **データベース**: RDS MySQL 8.0（完全移行完了）
- **デプロイ**: EC2上で直接実行
- **メリット**:
  - シンプルなアーキテクチャ
  - 開発環境と本番環境の統一
  - 高速なレスポンス（コールドスタートなし）

## 🏗 現在の本番環境アーキテクチャ

### Infrastructure Overview

```
┌─────────────────────────────────────────────────────────┐
│ AWS EC2 Instance (18.179.104.143)                      │
│                                                         │
│ ┌───────────────────────────────────────────────────┐ │
│ │ Nginx (Port 80) - Reverse Proxy                   │ │
│ │   ├─ / → localhost:3000 (Frontend)                │ │
│ │   └─ /api/ → localhost:3001/api/ (Backend)        │ │
│ └───────────────────────────────────────────────────┘ │
│                                                         │
│ ┌───────────────────────────────────────────────────┐ │
│ │ Application Layer                                 │ │
│ │   ├─ PM2: posl-frontend (Next.js)                 │ │
│ │   └─ Direct: node simple_final_api.js (Express)  │ │
│ └───────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────┐
│ AWS RDS MySQL 8.0                                       │
│ Host: posl-production.cxiucq08iku4.ap-northeast-1...  │
│ Database: posl_db                                       │
└─────────────────────────────────────────────────────────┘
```

### 技術スタック

#### バックエンド
- **Runtime**: Node.js 18.x LTS
- **Framework**: Express.js
- **Main File**: `simple_final_api.js`（ルートディレクトリ）
- **Database**: mysql2/promise（直接接続）
- **Process**: 直接実行（`node simple_final_api.js`）

#### フロントエンド
- **Framework**: Next.js 14
- **Language**: TypeScript
- **Styling**: Tailwind CSS
- **State Management**: Zustand
- **Process Manager**: PM2

#### Infrastructure
- **Web Server**: Nginx 1.18.0
- **OS**: Ubuntu 22.04 LTS
- **Database**: RDS MySQL 8.0 (Multi-AZ)
- **Storage**: S3 (音声ファイル)

### 重要な変更点

1. **Lambda関数からExpress.jsへ移行**
   - `backend/src/functions/` のLambda関数コードは残っているが未使用
   - `simple_final_api.js` が実際に使用されている

2. **データベース接続の統一**
   - すべてのエンドポイントで `mysql.createConnection()` を使用
   - 接続管理を各エンドポイントで実装（`finally`ブロックで確実にクローズ）

3. **プロンプト生成の改善**
   - データベースから設定を取得してプロンプトを動的生成
   - 曜日テーマ、トーン、プロンプト設定を反映
   - 人格プロファイルと日記データを組み込み

4. **音声日記機能の統合**
   - `/api/diary/transcribe` エンドポイント追加
   - 音声転写後に自動的にプロファイル更新
   - 日記一覧取得・削除機能

## 🔄 ローカル環境との関係

### 現在の状態

**本番環境**: 完全に独立した環境
- EC2上で直接実行
- RDS MySQLに直接接続
- ローカル環境への依存なし

**ローカル環境**: 開発用（オプション）
- 開発時のみ使用
- 本番環境への影響なし

### 不要なコード・設定

以下のコードは残っているが、現在は使用されていない：

1. **Lambda関数のコード**
   - `backend/src/functions/` ディレクトリ（24個のファイル）
   - `backend/serverless.yml`
   - `backend/webpack.config.js`

2. **DynamoDB関連のコード**
   - DynamoDB接続コード（既にMySQLに移行済み）

3. **ローカル開発用の設定**
   - `docker-compose.yml`（本番環境では使用しない）
   - ローカル用の環境変数設定

## 📝 推奨される整理作業

### 1. Lambda関数コードのアーカイブ

```bash
# アーカイブ先を作成
mkdir -p ドキュメント/archive/lambda-functions

# Lambda関数コードをアーカイブ
mv backend/src/functions ドキュメント/archive/lambda-functions/
mv backend/serverless.yml ドキュメント/archive/lambda-functions/
mv backend/webpack.config.js ドキュメント/archive/lambda-functions/
```

### 2. ドキュメントの更新

- README.md: 現在のアーキテクチャを反映
- 本番環境技術仕様書: Express.jsベースに更新
- 開発環境セットアップ: ローカル環境はオプションとして明記

### 3. 環境変数の整理

- 本番環境用の `.env` ファイルを明確に
- ローカル開発用の設定を分離

## ✅ 移行完了確認

- [x] Lambda関数からExpress.jsへ移行
- [x] DynamoDBからMySQLへ移行
- [x] 本番環境で直接実行
- [x] プロンプト生成機能の改善
- [x] 音声日記機能の統合
- [ ] Lambda関数コードのアーカイブ（推奨）
- [ ] ドキュメントの完全更新

---

**ステータス**: ✅ 本番環境移行完了  
**次回更新**: Lambda関数コードのアーカイブ後

