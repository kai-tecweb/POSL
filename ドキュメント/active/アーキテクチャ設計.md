# 🏗 POSL（ポスエル）V1 アーキテクチャ設計（移行後構成版）

**更新日**: 2025年11月17日  
**構成**: EC2+RDS(MySQL)+Express.js構成  
**移行完了予定**: 2025年2月13日

---

## 1. 全体イメージ（移行後）

目的：
毎日1回、AIが文章を生成して、ボスのXアカウントに自動投稿する。

大きく分けて4ブロック：
- フロントエンド（管理画面）- **変更なし**
- バックエンドAPI（アプリ本体）- **EC2+Express.js に移行**
- バッチ／スケジューラ（自動実行）- **node-cron に移行**
- 外部サービス連携（X・OpenAI・トレンド）- **変更なし**

---

## 2. 使用サービス（AWS移行後）

### 2-1. コンピューティング・API層
- **EC2 (t3.medium)**
  - Express.js統合APIサーバー（24時間稼働）
  - 投稿生成処理・設定CRUD・日記登録処理
  - PM2プロセス管理 + systemd自動起動
- **Application Load Balancer (ALB)**
  - EC2への負荷分散・ヘルスチェック
  - HTTPS終端・WAF連携

### 2-2. データベース・ストレージ
- **RDS MySQL 8.0 (Multi-AZ)**
  - ユーザー設定・投稿ロジック用データベース
  - JSON型でDynamoDBデータ完全移行
  - 保存する主なデータ：
    - X連携設定・曜日テーマ設定・イベント設定
    - トレンド設定・文体パラメータ・投稿テンプレ
    - 人格プロファイル・投稿ログ
- **S3**
  - 音声日記ファイル（元の音声）- **変更なし**
  - アプリケーションログバックアップ

### 2-3. スケジューリング・監視
- **node-cron（EC2内）**
  - 毎日20:00の投稿生成・週次人格更新・日次トレンド取得
  - PM2プロセス管理下で24時間稼働
- **CloudWatch**
  - 詳細監視・アラート・ログ集約
  - EC2・RDS・ALB の包括的監視

### 2-4. セキュリティ・運用
- **環境変数（dotenv）**
  - APIキー管理（OpenAI・X API）
  - データベース接続情報
- **WAF + Security Groups**
  - SQLインジェクション・XSS防御
  - ネットワークレベル制御
- **Route53 + CloudFront**
  - ドメイン管理・CDN配信

---

## 3. 外部サービス（API）- **変更なし**

- **X API**
  - POST /2/tweets で投稿
  - 認証：OAuth1.0a（Access Token & Secret）想定
- **OpenAI API**
  - GPT（投稿文生成・日記要約・人格更新）
  - Whisper（音声→テキスト）
- **トレンド取得**
  - Googleトレンド（PyTrendsなど）
  - Yahooトレンド / Yahooリアルタイム（HTML or RSS）
  - → EC2内のnode-cronが定期実行で取得

---

## 4. 処理フロー（移行後）

### 4-1. 設定系（管理画面操作）
- ユーザーがブラウザから管理画面にアクセス
- フロントエンド → **ALB → EC2(Express.js)**
- **Express.jsがMySQL（RDS）**から設定を読み書き
  - 曜日テーマ・文体設定・テンプレ選択
  - イベント登録・トレンドの利用有無など

### 4-2. 日記登録フロー（音声）
- 管理画面から音声ファイルをアップロード
- S3に保存（**変更なし**）
- **EC2のExpress.js**がWhisper APIに投げてテキスト化
- テキストを要約して「人格プロファイル用データ」として**MySQL**に保存

### 4-3. 自動投稿フロー（毎日20時）
- **EC2内のnode-cron**が毎日20:00に投稿処理起動
- **Express.js内のPromptEngine**がMySQLからその日の設定を取得
  - 曜日テーマ・直近の日記・人格プロファイル
  - 有効なイベント・トレンド設定
- **同一EC2内**でトレンド情報取得・GPTプロンプト生成
- 返ってきた投稿文をチェック（文字数など）
- X API（POST /2/tweets）で投稿（**変更なし**）
- 投稿内容・レスポンスを**MySQL**に投稿ログとして保存

### 4-4. 手動プレビュー＆投稿
- 管理画面から「今日の投稿をプレビュー」ボタン
- **Express.js**が同じロジックで文章だけ生成
- フロントで表示し、ユーザーがOKなら「今すぐ投稿」ボタン
- X APIで投稿（**変更なし**）

### 4-5. **新機能: リアルタイム更新（移行後追加可能）**
- **WebSocket対応**でフロントエンドにリアルタイム通知
- 投稿生成進捗・エラー状況の即座更新
- EC2常駐の利点活用

---

## 5. セキュリティ・権限（移行後）

### 5-1. 認証・認可
- **環境変数管理**（dotenv）でAPIキー管理
  - OpenAI API Key / X API Keys
  - MySQL接続情報
- **IAMロール**（最小権限の原則）
  - S3音声バケットアクセスのみ
  - CloudWatch監視データ送信のみ

### 5-2. ネットワークセキュリティ
- **VPC設計**：Public Subnet（ALB）+ Private Subnet（EC2・RDS）
- **セキュリティグループ**：
  - ALB：HTTPS(443)のみ外部公開
  - EC2：ALBからの3001ポートのみ許可
  - RDS：EC2からの3306ポートのみ許可
- **WAF**：SQLインジェクション・XSS攻撃防御

### 5-3. データ暗号化
- **保存時**：RDS・S3・EBS全て暗号化（AWS KMS）
- **転送時**：HTTPS必須・TLS 1.2以上・RDS SSL接続
- LambdaからはIAMロールでSecrets取得
- DynamoDBはテーブル単位で権限制御
- 外部にはAPIキーを絶対出さない構成

---

## 6. 将来拡張のためのフック（V1のうちに用意）

  - user_id
  - account_id
  をキーに含める設計にしておく

---

## 7. 補強・調整ポイント（総合レビュー反映）

### 7-1. Lambda構成の明確化

- Whisper（音声→テキスト変換）は「音声日記アップロード時のみ」専用Lambdaで実行
- GPT（文章生成・日記要約・人格更新）は「投稿生成」「日記要約」「人格プロファイル更新」など用途ごとにLambdaを分離
- これによりUIの「音声日記は即時反映」要件も満たす

### 7-2. トレンド取得の統合

- トレンド情報は「投稿生成Lambda」内で毎回取得・合成する（定期取得Lambdaは不要）
- プレビュー生成時も最新トレンドを利用

### 7-3. 認証方式の柔軟化

- X APIはOAuth1.0a（V1.0）
- 将来Instagram/Facebook等はOAuth2.0
- 認証方式は「プラットフォームごとに切り替え可能」な構造を設計時点で明記

### 7-4. プロンプト生成アルゴリズム例

1. テンプレ（型）を選択
2. 文体パラメータ（スライダー値）を適用
3. イベントの有無・挙動を判定
4. トレンド混ぜ割合・スタイルを適用
5. 人格プロファイル（日記要素）を加える
6. プロンプト追加ルールを適用
7. これらを合成してAIプロンプトを生成

### 7-5. 投稿ログの保存内容（例）

- 投稿日時
- 用いたテンプレ（型）
- 文体設定値
- トレンド混ぜ割合・スタイル
- イベント名
- 実際にGPTへ投げたプロンプト全文
- GPT生成結果
- X投稿レスポンス（tweet_id等）

### 7-6. APIエンドポイントと画面対応一覧

| 画面 | APIエンドポイント例 |
|---|---|
| 投稿時刻設定 | /settings/post-time |
| 曜日テーマ設定 | /settings/week-theme |
| イベント管理 | /settings/event |
| トレンド設定 | /settings/trend |
| 文体・トーン設定 | /settings/tone |
| テンプレ管理 | /settings/template |
| プロンプト微調整 | /settings/prompt |
| 音声日記アップロード | /diary/upload |
| 日記一覧 | /diary/list |
| 投稿ログ | /post/logs |
| テスト投稿 | /test/post |
| **投稿ステータス監視** | **/posts/status** |
| **投稿ステータス更新** | **/posts/update-status** |
| **エラーログ取得** | **/system/errors** |

### 7-7. フロントエンド技術スタック（推奨）

- Next.js（Reactベース）
- Tailwind CSS
- AWS Amplify Hosting（静的ホスティング）
- カード型UI設計と相性が良い

### 7-8. Phase 4実装完了：リアルタイム監視とエラーハンドリング

#### 投稿ステータス監視システム
- **PostStatusMonitor コンポーネント**
  - リアルタイム投稿ステータス表示（10秒間隔のポーリング）
  - ステータス可視化：準備中→生成中→投稿中→完了/失敗
  - 手動リフレッシュ機能
- **getPostStatus API**
  - DynamoDB投稿ログテーブルからステータス情報取得
  - ステータスフィルタリング機能
- **updatePostStatus API**  
  - 投稿プロセス各段階でのステータス更新
  - 条件付き更新（楽観的排他制御）

#### エラーハンドリング・ログシステム
- **ErrorLogMonitor コンポーネント**
  - システムエラーのリアルタイム表示
  - エラーレベル（INFO/WARN/ERROR）による色分け
  - タイムスタンプ付きエラー履歴
- **拡張されたエラーハンドリング**
  - exponential backoff retry機能（最大3回試行）
  - 詳細なエラーログとスタックトレース
  - 外部API（OpenAI/X API）障害時の適切な対応

#### 設定同期システム
- **フロントエンド⇄DynamoDB連携**
  - Zustandストアからの自動同期
  - 設定変更の即座反映
  - API呼び出しエラー時のフォールバック

---

## 📊 移行実装ステータス（2025年11月17日更新）

### ✅ Phase 6完了済み項目

#### MySQL環境構築・統合
- **MySQL 8.0環境**: Docker + 本体環境で稼働確認済み
- **MySQLHelper実装**: DynamoDB完全互換API実装完了
- **スキーマ移行**: 全5テーブル（users, settings, post_logs, diaries, persona_profiles）
- **データ互換性**: JSON型活用でNoSQL柔軟性維持

#### PromptEngine MySQL統合
- **コア機能移行**: 全8設定取得メソッドMySQL対応完了
- **プロンプト生成**: システム(418文字)+ユーザー(414文字)正常動作確認
- **統合テスト**: test-runner 17ケース実行成功
- **API動作**: Serverless Offline環境でのMySQL連携確認

#### 開発環境最適化
- **TypeScript設定**: 非推奨警告解消、ビルドエラー完全解決
- **並行運用**: MySQL(3307) + DynamoDB(8000) + API(3001)同時稼働

### 🔄 実装中・次フェーズ項目

#### 残りAPI関数移行
- **diary系**: getDiaries, uploadAudio, transcribeAudio等（6ファイル）
- **posts系**: getPostLogs, updatePostStatus等（4ファイル）  
- **scheduler系**: generateAndPost（1ファイル）
- **persona系**: getPersonaProfile（1ファイル）

#### 本格稼働準備
- **認証設定調整**: MySQL外部接続設定
- **外部API連携テスト**: OpenAI、トレンド取得との統合
- **パフォーマンス調整**: レスポンス時間最適化

### 📈 移行進捗
- **基盤構築**: 100%完了
- **PromptEngine移行**: 100%完了  
- **全API移行**: 15%完了（設定系API完了、他20+ファイル残存）
- **総合進捗**: 75%完了

**予定**: Phase 7で残りAPI移行完了により MySQL移行完了予定

---
