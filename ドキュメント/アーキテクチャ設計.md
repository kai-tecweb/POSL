# 🏗 POSL（ポスエル）V1 アーキテクチャ設計・再整理版

---

## 1. 全体イメージ

目的：
毎日1回、AIが文章を生成して、ボスのXアカウントに自動投稿する。

大きく分けて4ブロック：
- フロントエンド（管理画面）
- バックエンドAPI（アプリ本体）
- バッチ／スケジューラ（自動実行）
- 外部サービス連携（X・OpenAI・トレンド）

---

## 2. 使用サービス（AWS）

- API Gateway
  - 管理画面 → バックエンドLambdaへの入口
- AWS Lambda
  - 投稿生成処理
  - 設定のCRUD（作成・読み取り・更新・削除）
  - 日記の登録＆要約
  - トレンド取得処理
- EventBridge
  - 毎日20:00に「今日の投稿生成＆X投稿」を起動
- DynamoDB
  - ユーザー設定・投稿ロジック用のデータベース
  - 保存する主なデータ：
    - X連携設定（アカウントIDなど）
    - 曜日テーマ設定
    - イベント設定
    - トレンド設定
    - 文体パラメータ
    - 投稿テンプレ（型）
    - 人格プロファイル（要約済み日記）
    - 投稿ログ（いつ・どんな内容を投稿したか）
- S3
  - 音声日記ファイル（元の音声）
  - 将来的なバックアップデータ
- Secrets Manager
  - X API Key / Secret
  - X Access Token / Secret
  - OpenAI API Key
  - （他のAPIキーもここに）

---

## 3. 外部サービス（API）

- X API
  - POST /2/tweets で投稿
  - 認証：OAuth1.0a（Access Token & Secret）想定
- OpenAI API
  - GPT（投稿文生成・日記要約・人格更新）
  - Whisper（音声→テキスト）
- トレンド取得
  - Googleトレンド（PyTrendsなど）
  - Yahooトレンド / Yahooリアルタイム（HTML or RSS）
  - → Lambdaが定期 or 投稿時に取得

---

## 4. 処理フロー（ざっくり）

### 4-1. 設定系（管理画面操作）
- ユーザーがブラウザから管理画面にアクセス
- フロントエンド → API Gateway → Lambda
- LambdaがDynamoDBから設定を読み書き
  - 曜日テーマ
  - 文体設定
  - テンプレ選択
  - イベント登録
  - トレンドの利用有無
  - など

### 4-2. 日記登録フロー（音声）
- 管理画面から音声ファイルをアップロード
- S3に保存
- LambdaがWhisper APIに投げてテキスト化
- テキストを要約して「人格プロファイル用データ」としてDynamoDBに保存

### 4-3. 自動投稿フロー（毎日20時）
- EventBridgeが毎日20:00に Lambda を起動
- Lambda が DynamoDB からその日の設定を取得
  - 曜日テーマ
  - 直近の日記・人格プロファイル
  - 有効なイベント（今日がイベント日か？）
  - トレンド設定
- 必要なら別Lambdaでトレンド情報取得
- 集めた情報をもとに GPT に「投稿生成プロンプト」を投げる
- 返ってきた投稿文をチェック（文字数など）
- X API（POST /2/tweets）で投稿
- 投稿内容・レスポンスを DynamoDB に投稿ログとして保存

### 4-4. 手動プレビュー＆投稿（将来 or オプション）
- 管理画面から「今日の投稿をプレビュー」ボタン
- Lambdaが同じロジックで文章だけ生成
- フロントで表示し、ユーザーがOKなら「今すぐ投稿」ボタン
- X APIで投稿

---

## 5. セキュリティ・権限

- Secrets Manager でAPIキーを管理
- LambdaからはIAMロールでSecrets取得
- DynamoDBはテーブル単位で権限制御
- 外部にはAPIキーを絶対出さない構成

---

## 6. 将来拡張のためのフック（V1のうちに用意）

  - user_id
  - account_id
  をキーに含める設計にしておく

---

## 7. 補強・調整ポイント（総合レビュー反映）

### 7-1. Lambda構成の明確化

- Whisper（音声→テキスト変換）は「音声日記アップロード時のみ」専用Lambdaで実行
- GPT（文章生成・日記要約・人格更新）は「投稿生成」「日記要約」「人格プロファイル更新」など用途ごとにLambdaを分離
- これによりUIの「音声日記は即時反映」要件も満たす

### 7-2. トレンド取得の統合

- トレンド情報は「投稿生成Lambda」内で毎回取得・合成する（定期取得Lambdaは不要）
- プレビュー生成時も最新トレンドを利用

### 7-3. 認証方式の柔軟化

- X APIはOAuth1.0a（V1.0）
- 将来Instagram/Facebook等はOAuth2.0
- 認証方式は「プラットフォームごとに切り替え可能」な構造を設計時点で明記

### 7-4. プロンプト生成アルゴリズム例

1. テンプレ（型）を選択
2. 文体パラメータ（スライダー値）を適用
3. イベントの有無・挙動を判定
4. トレンド混ぜ割合・スタイルを適用
5. 人格プロファイル（日記要素）を加える
6. プロンプト追加ルールを適用
7. これらを合成してAIプロンプトを生成

### 7-5. 投稿ログの保存内容（例）

- 投稿日時
- 用いたテンプレ（型）
- 文体設定値
- トレンド混ぜ割合・スタイル
- イベント名
- 実際にGPTへ投げたプロンプト全文
- GPT生成結果
- X投稿レスポンス（tweet_id等）

### 7-6. APIエンドポイントと画面対応一覧

| 画面 | APIエンドポイント例 |
|---|---|
| 投稿時刻設定 | /settings/post-time |
| 曜日テーマ設定 | /settings/week-theme |
| イベント管理 | /settings/event |
| トレンド設定 | /settings/trend |
| 文体・トーン設定 | /settings/tone |
| テンプレ管理 | /settings/template |
| プロンプト微調整 | /settings/prompt |
| 音声日記アップロード | /diary/upload |
| 日記一覧 | /diary/list |
| 投稿ログ | /post/logs |
| テスト投稿 | /test/post |

### 7-7. フロントエンド技術スタック（推奨）

- Next.js（Reactベース）
- Tailwind CSS
- AWS Amplify Hosting（静的ホスティング）
- カード型UI設計と相性が良い

---
