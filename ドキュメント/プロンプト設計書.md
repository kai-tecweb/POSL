# 🧩 POSL V1 プロンプト設計書

---

## 1. プロンプトエンジンの役割

POSLのプロンプトエンジンは、次の素材を組み合わせて「1日1本・140文字前後のX投稿文」を生成する頭脳部分。

### 組み合わせる素材
- 曜日テーマ（今日の投稿の方向性）
- イベント（記念日・季節行事など）
- トレンド（Google / Yahoo）
- 日記データ（音声→テキストの要約）
- 人格プロファイル（ユーザーの人柄要約）
- 文体・トーン設定（スライダー・プロファイル）
- 投稿テンプレ（文章の型）
- プロンプト微調整（追加ルール / NGワード / 好きな表現）

イメージとしては：「テンプレ＝レシピ、文体＝味付け、日記・人格・トレンド＝具材、プロンプトエンジン＝シェフ」

---

## 2. プロンプトエンジンの入力パラメータ

1回の生成処理で、GPTに渡す前に内部でまとめる情報：

### 基本情報
- **weekday_theme**: 今日の曜日に対応するテーマ（宣伝・知識・失敗談・トレンドなど）
- **event**: 今日が該当するイベント情報（バレンタインなど）、null の場合はイベントなし

### トレンド関連
- **trend_items**: Google/Yahooから取得したトレンドワード（フィルタ済み）
- **trend_settings**: 
  - 混ぜる割合（0〜100%）
  - 混ぜ方スタイル（一言だけ / 軽く雑談 / しっかり / ユーモア）

### 人格・日記関連
- **persona_profile**: 日記から生成された人格要約（性格・よく話す話題など）
- **recent_diary_summaries**: 直近の日記の短い要約リスト

### 文体・表現関連
- **tone_profile**: 丁寧さ・カジュアルさ・ポジティブ度・専門度・感情の濃さ・比喩・絵文字レベルなど
- **template_id**: 使用する文章テンプレのID（共感スタート型・3ポイント型など）

### カスタム設定
- **extra_instructions**: ユーザーがプロンプト微調整画面で書いた追加ルール
- **ng_words**: 使ってほしくない単語一覧
- **preferred_phrases**: よく使ってほしい言い回し
- **creativity_level**: AIの自由度（0.0〜1.0想定）

---

## 3. プロンプト全体構造

GPTへのプロンプトは、大きく分けて「システムメッセージ」と「ユーザーメッセージ」で構成する。

### 3-1. システムメッセージ（役割＆ルール）

#### 役割指定
「あなたは、ユーザー本人の分身としてX投稿を書くAIです。」

#### 基本方針
- 読んだ人が少し前向きになること
- 専門用語は少なめ、使う時はできるだけ噛み砕く
- 売り込み感が強すぎない（宣伝テーマ時は例外・ソフトに）

#### 文量制約
- 原則 140文字前後（日本語想定）
- 必要なら短めを優先（スクロールしないで読める長さ）

#### NG事項
- 暴力・差別・政治・炎上ネタなど
- ng_words の単語は使わない

#### 絵文字ルール
- tone_profile.emoji_level に応じて、絵文字の個数と頻度を制御

#### 文体ルール
- 「ですます」/「だ・である」 を tone_profile に合わせて統一
- 一人称（「私」「僕」など）は人格プロファイルに合わせる

### 3-2. ユーザーメッセージ（具体的な条件）

ユーザーメッセージ部分には、「今日の条件」を一まとめにしてGPTに渡す。

#### 含める内容（例）
- 今日の曜日テーマとその説明
- 今日がイベント日かどうかとイベント内容
- 今日使うテンプレ（型）の構造説明
- 文体パラメータ（トーン情報）
- 人格プロファイル（要約）
- 直近の日記サマリ（2〜3個まで）
- トレンドワード（フィルタ済み）
- トレンドの混ぜ方（どの程度、どう絡めるか）
- 追加ルール / NGワード / 好きな表現

---

## 4. テンプレ別の構成ルール

テンプレ（型）は、プロンプト内で「構造」として伝える。

### 例）共感スタート型
1. 1文目：読者の「あるある」や気持ちに共感する一文
2. 2文目：自分の体験・気づき・日記からの一部
3. 3文目：前向きなひと言 or 小さな提案

### 例）トレンド紐付け型
1. 1文目：今日のトレンドの中から1つ触れる
2. 2文目：それに対する自分の感想・日記や人格を絡める
3. 3文目：投稿を読んだ人が元気になるようなひと言で締める

こういった「型の説明」をプロンプトに含めて、GPTが文章を組み立てやすいようにする。

※ V1ではテンプレ構造はシステム側固定、UIからは「どの型を使うか／優先するか」だけ選ぶ。

---

## 5. 曜日テーマ＆イベント＆トレンドの扱い

### 曜日テーマ
- その日の「目的・方向性」として明示
- 例：「今日は『失敗談』の日。自分の過去の失敗から1つ選び、そこからの学びを書く。」

### イベント
- イベント日なら：「今日は◯◯（イベント名）です。」をプロンプトに含める
- イベント用テンプレがあれば、その構造を優先

### トレンド
- トレンドの混ぜ方（blend_ratio / style）に応じて指示
- 例：「トレンドワードは【◯◯】です。一言だけ触れ、商品やサービスとは無理に結びつけないでください。」

---

## 6. 文体・トーンの反映ルール

tone_profile の数値を、人間に分かる指示に変換してプロンプトに渡す。

### 変換例
- 丁寧さ：0.8 → 「丁寧だが堅すぎない言葉で」
- カジュアルさ：0.4 → 「カジュアルさは控えめ」
- ポジティブ度：0.9 → 「全体として前向きな印象になるように」
- 専門度：0.2 → 「専門用語はできるだけ使わず、小学生にも分かる表現を意識する」
- 感情の濃さ：0.7 → 「適度に気持ちが伝わるような表現を入れる」
- 比喩の量：0.6 → 「時々、軽い比喩表現を使ってよい」

---

## 7. プロンプト微調整の扱い

「プロンプト微調整」画面でユーザーが設定した内容は、そのまま"追加ルールの塊"としてプロンプト末尾に付ける。

### 設定例
- **extra_instructions**: 「専門用語を使うときは必ず一文で補足してください。」
- **ng_words**: 「『値下げ』『ギリギリ』『炎上』という言葉は使わないこと。」
- **preferred_phrases**: 「『じんわり』『一歩ずつ』を時々使ってよい。」

### creativity_level に応じて
- **低**: テンプレとルールに忠実に、変化少なめ
- **中**: ルール守りつつ、言い回しなどは柔軟に
- **高**: ルールをベースにしつつ、比喩や展開に自由度を持たせる

---

## 8. 出力仕様（X投稿としての制約）

生成された文章は、X投稿として次の制約を守る：

- 原則 140文字前後（最大280文字以内）
- URLやハッシュタグはV1では基本付けない（必要なら後で拡張）
- 絵文字の数は tone_profile.emoji_level に応じて 0〜3個程度
- 自己紹介や毎回同じフレーズの連発は避ける
- 連投を前提とした構造（「その2へ続く」など）は使わない

---

## 9. 投稿ログに保存するプロンプト関連情報

後から改善・解析できるよう、以下も投稿ログに保存する：

### 保存項目
- 実際にGPTへ送ったプロンプト（テキスト）
- GPTのレスポンス（完成文章）

### 使用した設定情報
- テンプレID
- トーンプロファイルID
- 曜日テーマ
- イベントID（あれば）
- トレンドワード（採用したもの）
- creativity_level など

---

---

## 11. 最終プロンプト例（実際にGPTへ送る形）

ここでは、実際にGPTへ渡す「system」「user」メッセージの具体例を示す。

### 11-1. 前提条件（サンプル想定）

- **曜日**: 水曜日（テーマ：失敗談・学び）
- **イベント**: なし
- **トレンド**: ["睡眠不足", "働き方", "残業"]（薄めに使用）
- **テンプレ**: 共感スタート型（template_id = "empathy_start"）
- **文体**:
  - 丁寧さ：0.8
  - カジュアル：0.4
  - ポジティブ：0.9
  - 専門度：0.2
  - 感情の濃さ：0.7
  - 比喻：0.5
  - 絵文字レベル：0.3
- **人格プロファイル（要約）**: 「フリーランスのエンジニア。AI活用と子どもへの技術継承に関心。丁寧で前向き。」
- **直近の日記サマリ（例）**: 「昨日はタスクを詰め込みすぎて、夜遅くまでPCに向かってしまった。」
- **プロンプト微調整**:
  - extra_instructions: 「専門用語を使うときは一文で補足を書く。」
  - ng_words: ["炎上", "ブラック企業"]
  - preferred_phrases: ["じんわり", "一歩ずつ"]
  - creativity_level: 0.6（"ほどよく自由"）

### 11-2. Systemメッセージ例

```
あなたは、ユーザー本人の「分身」としてX（旧Twitter）に投稿する日本語文章を作るAIです。

▼基本方針
- 読んだ人が少し前向きになるような内容にしてください。
- 売り込み感や宣伝感を強く出しすぎないでください。
- 専門用語はできるだけ少なくし、使う場合は短い補足説明を入れてください。
- 毎回の投稿は1つのツイート内で完結させてください（連投前提の構成は禁止）。

▼文量・形式
- 140文字前後を目安とし、最大でも280文字以内に収めてください。
- 絵文字は0〜3個までにしてください。使いすぎないでください。
- ハッシュタグやURLは今回のバージョンでは基本的に使わないでください。

▼文体・口調
- 「です・ます調」で統一してください。
- やや丁寧だが、堅すぎない口調で書いてください。
- カジュアルさは控えめにし、大人の読者にも違和感がないトーンにしてください。
- 全体として前向きで、読んだ人がほっとするような雰囲気を目指してください。
- 一人称は「私」を使ってください。

▼NG事項
- 暴力、差別、政治、宗教、誹謗中傷に関する内容は書かないでください。
- 次の単語は使わないでください: 「炎上」「ブラック企業」。
- 不安や恐怖を煽るような表現は避けてください。

以上のルールを必ず守りながら、後続の指示（ユーザーメッセージ）に従って投稿文を1つだけ生成してください。
```

### 11-3. Userメッセージ例

```
# 今日の投稿テーマ（曜日テーマ）
今日は「失敗談からの学び」をテーマにした投稿を書いてください。
過去の自分の失敗を1つ取り上げて、そこから得た気づきや学びをやさしく共有するイメージです。

# 人格プロファイル（要約）
- フリーランスのエンジニア。
- AI活用や自動化が好きだが、人との対話や子どもへの技術継承も大事にしている。
- 基本的に前向きで、読んだ人を励ましたいと思っている。
- 丁寧で思いやりのある性格。

# 直近の日記の要約
1. 昨日はタスクを詰め込みすぎて、夜遅くまでPCに向かってしまった。
2. その結果、翌朝は頭が重くて集中力が落ちてしまい、結局進みが悪くなった。

これらの日記内容を参考に、「やりすぎてしまった働き方の失敗談」と「そこから学んだペース配分の大切さ」を伝えてください。

# トレンド情報
今日のトレンドワード（参考）:
- 睡眠不足
- 働き方
- 残業

トレンドは「軽く一言だけ」触れる程度にしてください。
無理に商品の宣伝やサービスと結びつけたりせず、
「最近こういう話題もあるよね」と共感を添えるくらいで構いません。

# 使用するテンプレ（文章の型）
テンプレID: empathy_start（共感スタート型）

構成:
1. 1文目: 読者の「あるある」や気持ちに共感する一文。
2. 2文目: 自分の具体的な失敗エピソードを短く紹介する。
3. 3文目: そこからの気づきや学びを、前向きなひと言としてまとめる。

# 文体・トーン
- 丁寧でやさしい「です・ます調」。
- ポジティブ度は高め。
- 感情は少し込めてよいが、重くならないように。
- 比喩はあっても良いが、使うなら1つまで。
- 絵文字は使うとしても1つまでにしてください。

# プロンプト微調整
追加ルール:
- 専門用語を使うときは、1文で短い補足説明をつけてください。

NGワード:
- 炎上
- ブラック企業

よく使ってほしい表現:
- 「じんわり」
- 「一歩ずつ」

# 出力フォーマット
- Xにそのまま投稿できる本文だけを出力してください。
- 前後に説明文やラベルはつけず、日本語の文章1本のみを出力してください。
```

この形をベースに、各種パラメータを差し替えていくイメージ。

---

## 12. テンプレ10種の構造設計

テンプレ（文章の型）は、AIの出力の安定性を決める重要要素。
各テンプレごとに、目的・構造・文字数目安・注意点を定義する。

### 共通ルール
- 文字数の総量は 140文字前後（最大280文字以内）
- 原則「3文構成」を基本とし、テンプレによっては2〜4文許容
- 最後の文は必ず「前向きさ」「余韻」「ほっとする感じ」で締める

### 12-1. T1 共感スタート型（empathy_start）
- **目的**: 読者の「あるある」に寄り添いながら、自分の体験と学びをシェア
- **構造**:
  1. 共感の一文（「ありますよね」「つい〇〇しちゃう」など）
  2. 自分の具体的な体験・失敗・気づき
  3. 小さな学び・前向きな一言・明日への一歩
- **文字数目安**: 3文で120〜160文字
- **注意点**: 読者を責めるようなトーンはNG、自虐が重くなりすぎないように

### 12-2. T2 一言パンチライン型（punch_line）
- **目的**: 強い一言でスクロールを止め、短い理由付け＋前向きなオチ
- **構造**:
  1. 印象に残る一言（短め・10〜20文字）
  2. なぜそう思うのか、背景理由を1〜2文で補足
  3. 読者への一言メッセージ or 行動のヒント
- **文字数目安**: 2〜3文で80〜140文字
- **注意点**: 過激さよりも「深いけどやさしい」を優先、命令口調になりすぎないように

### 12-3. T3 トレンド紐付け型（trend_link）
- **目的**: 今日の話題に軽く触れつつ、自分の視点や感じたことを添える
- **構造**:
  1. トレンドワードに一言触れる（ニュース風ではなく、素朴な感想寄り）
  2. それに関連する自分の体験・考え・仕事・日常の一部
  3. 読者が「そうそう」「たしかに」と思える前向きコメント
- **文字数目安**: 3文で120〜160文字
- **注意点**: 商品やサービスに無理やり結びつけない、センシティブジャンル（政治・事件）は除外

### 12-4. T4 ミニストーリー型（mini_story）
- **目的**: 短い1エピソードで「情景＋気づき」を伝える
- **構造**:
  1. シーンの一文（いつ・どこ・どんな状況）
  2. 起きた出来事 or 感情の動き
  3. そこからの学び・気づき・今日の結論
- **文字数目安**: 3文で130〜180文字
- **注意点**: 登場人物は基本「自分」＋1まで、小説っぽくなり過ぎず、現実的な日常レベルで

### 12-5. T5 ノウハウ1ポイント型（one_tip）
- **目的**: 役立つ知識や工夫を、1つだけ分かりやすく伝える
- **構造**:
  1. 課題・悩みの提示（「〇〇で困ったことありませんか？」など）
  2. それに対する「1つのコツ・方法」を具体的に説明
  3. 「完璧じゃなくていいので、まずはここから」で締める
- **文字数目安**: 3文で120〜160文字
- **注意点**: 専門用語はかみ砕く、情報を詰め込みすぎない（1ポイントに絞る）

### 12-6. T6 失敗談から学び型（fail_learn）
- **目的**: 自分の失敗をさらけ出しつつ、そこからの学びをシェア
- **構造**:
  1. 失敗シーンを一言で紹介（「やってしまった…」など）
  2. 何が原因で、どんな結果になったか
  3. 同じ失敗を減らすための工夫や、今の考え方
- **文字数目安**: 3文で130〜170文字
- **注意点**: 読者が不安になるような重すぎる失敗は避ける、自己否定ではなく「成長の材料」として扱う

### 12-7. T7 今日の気づき型（today_insight）
- **目的**: その日ふと感じた小さな気づきを言語化する
- **構造**:
  1. 今日あった事実 or 小さな出来事
  2. そこから感じたこと・気づいたこと
  3. 読者への「一緒にこうしていけたらいいですね」という提案や共感
- **文字数目安**: 3文で100〜150文字
- **注意点**: 抽象論だけにならないよう、必ず「具体エピソード」を1つ入れる

### 12-8. T8 雑談型（casual_talk）
- **目的**: 宣伝色ゼロで、ゆるく人柄を出す
- **構造**:
  1. ゆるいオープニング（天気・日常・ちょっとした出来事）
  2. それに対する自分の感想や、小さなこだわり
  3. 「みなさんはどうですか？」的な問いかけ or ほっこり締め
- **文字数目安**: 3文で100〜150文字
- **注意点**: 長い愚痴にならないよう注意、ネガティブ一色では終わらない

### 12-9. T9 イベント特化型（event_special）
- **目的**: 誕生日・記念日・季節行事などの「特別な日」を祝う
- **構造**:
  1. イベント名と、「今日は◯◯ですね」という一文
  2. そのイベントに対する自分の思い出・想い・感謝
  3. 読者や関係者への「ありがとう」や「おめでとう」で締める
- **文字数目安**: 3文で120〜180文字
- **注意点**: 売り込みは極力控えめ（感謝メイン）、過度にテンション高すぎる文体は避け、POSLの基本トーンに合わせる

### 12-10. T10 3ポイント型（three_points）
- **目的**: 1つのテーマについて、3つのポイントで整理して伝える
- **構造**:
  1. テーマ宣言（「今日は〇〇の3つのポイントについて」など）
  2. 箇条書き風に3ポイント（文章として続けてもOK）例：「①〜」「②〜」「③〜」
  3. 「全部できなくてOK、1つだけでも試してみましょう」で締める
- **文字数目安**: 3文で140〜200文字
- **注意点**: 1ポイントあたりの説明は短く、情報を3つ以上詰めない（4つ以上はNG）

---

## 13. tone_profile 実装用数値仕様

フロントエンドのスライダー（0〜100）と、バックエンド内部の数値（0.0〜1.0）を対応させる。

### 13-1. UI値 → 内部値変換ルール
- **UIスライダー**: 0〜100
- **内部値**: 0.0〜1.0
- **変換式**: internal_value = slider_value / 100.0

### 13-2. パラメータ一覧

| キー名 | 意味 | 0.0 付近 | 0.5 付近 | 1.0 付近 |
|---|---|---|---|---|
| politeness | 丁寧さ | くだけた、フランク | 普通のていねいさ | かなり丁寧（敬語多め） |
| casualness | カジュアルさ | フォーマル寄り | ほどよく砕けた | かなりフレンドリー・友達口調 |
| positivity | ポジティブ度 | 落ち着き〜中立 | やや前向き | 強めに前向き、励まし多め |
| technicality | 専門度 | ほぼ専門用語なし | 必要最低限の専門用語 | 専門用語多め（※V1では0.6以上は推奨しない） |
| emotion | 感情の濃さ | ほぼ感情を出さない | さりげなく感情がにじむ | 感情表現豊か（ただし大げさすぎないよう調整） |
| metaphor | 比喩の量 | 比喩ほぼなし | 時々比喩を使う | 比喩をよく使う（V1では0.7程度まで推奨） |
| emoji_level | 絵文字の使用度 | 絵文字なし | 1個前後 | 最大3個程度 |

※ politeness と casualness は矛盾させない範囲で設定するのが望ましい（どちらも1.0、などは基本避ける）。

### 13-3. 推奨プリセット例

**P1：やさしく丁寧（デフォルト候補）**
- politeness: 0.8
- casualness: 0.4
- positivity: 0.9
- technicality: 0.3
- emotion: 0.7
- metaphor: 0.5
- emoji_level: 0.3

**P2：少しカジュアル寄り**
- politeness: 0.6
- casualness: 0.6
- positivity: 0.8
- technicality: 0.2
- emotion: 0.6
- metaphor: 0.5
- emoji_level: 0.5

**P3：ビジネス寄り・落ち着き**
- politeness: 0.9
- casualness: 0.2
- positivity: 0.7
- technicality: 0.4
- emotion: 0.4
- metaphor: 0.3
- emoji_level: 0.1

### 13-4. GPTへの文言変換イメージ

内部値 → プロンプト文言例：

- `politeness >= 0.7` → 「丁寧だが堅すぎない言葉で書いてください。」
- `casualness <= 0.3` → 「カジュアルすぎない表現にしてください。」
- `positivity >= 0.8` → 「全体として前向きな印象になるようにしてください。」
- `emoji_level == 0` → 「絵文字は使わないでください。」
- `emoji_level > 0 && emoji_level <= 0.4` → 「絵文字は使っても1個までにしてください。」

---

## 15. Phase 4 エラーハンドリング拡張時のプロンプト設計変更

### 15-1. エラー時プロンプト再試行戦略

Phase 4で実装されたexponential backoffリトライ機能により、プロンプト生成時のエラーハンドリングが拡張された。

**リトライ戦略**:
1. **1回目の失敗**: 元のプロンプトで即座に再試行
2. **2回目の失敗**: プロンプトを簡略化して再試行
   - トレンド要素を削除
   - 文体設定をデフォルトに戻す
   - 追加ルールを無視
3. **3回目の失敗**: 最小限プロンプトで再試行
   - 曜日テーマのみ使用
   - 全ての装飾要素を削除

### 15-2. エラー時プロンプト文言調整

```
// 簡略化プロンプト例（2回目失敗時）
"今日のテーマに沿って140文字程度のソーシャルメディア投稿を書いてください。
テーマ: {weekday_theme}
人格: {basic_persona}
シンプルで分かりやすい表現でお願いします。"

// 最小限プロンプト例（3回目失敗時）  
"以下のテーマで140文字のTwitter投稿を書いてください。
テーマ: {weekday_theme}
自然な日本語で、前向きな内容にしてください。"
```

### 15-3. エラーログ記録対象

投稿生成プロセスで記録されるエラー情報:
- プロンプト生成失敗（不正な入力値、テンプレート解析エラー）
- OpenAI API エラー（レート制限、接続エラー、レスポンスタイムアウト）
- X API投稿エラー（認証失敗、文字数制限超過、重複投稿）
- 各リトライ段階でのプロンプト内容変更ログ

これにより、システム障害時も適切なフォールバック動作を維持し、投稿品質の一定水準を保つ。

---

## 14. 要点まとめ

これでプロンプト設計書は：
- 「何をどう渡すか」がわかる具体プロンプト例
- 出力の安定性を担保するテンプレ10種の構造ルール
- フロントとバックをつなぐtone_profile数値仕様
- **Phase 4: エラー時のプロンプト調整・リトライ戦略**

これでプロンプト設計書は：
- 「何をどう渡すか」がわかる具体プロンプト例
- 出力の安定性を担保するテンプレ10種の構造ルール
- フロントとバックをつなぐtone_profile数値仕様
- **Phase 4: エラー時のプロンプト調整・リトライ戦略**

まで揃ったので、そのまま実装に落とし込めるレベルになった。

## 📊 実装ステータス（2025年11月17日更新）

### ✅ 完了済み実装
1. **PromptEngineクラス実装完了**
   - 全8つの設定取得メソッド
   - システム/ユーザープロンプト分離設計
   - MySQL統合（DynamoDBからの移行完了）

2. **プロンプト生成機能確認済み**
   - システムプロンプト: 418文字（文体・ルール・制約）
   - ユーザープロンプト: 414文字（今日の条件・素材）
   - コンテキスト統合: 週テーマ、トーン、人格プロファイル

3. **テスト環境整備**
   - test-runner実装（17テストケース）
   - MySQLHelper統合テスト成功
   - API動作確認済み

### 🔄 実装中・今後の拡張
- 残りAPI関数のMySQL移行（20+ファイル）
- 外部API連携テスト（OpenAI、トレンド取得）
- エラーハンドリング戦略の本格実装

- POSLのプロンプトは「テンプレ（構造）×文体（味付け）×人格（日記）×トレンド（今っぽさ）」をバランスよく混ぜるように設計
- 生のプロンプト全文はシステムで管理し、ユーザーは「方向性・ルール・好み」をUIで調整するだけでOK
- 投稿ログにプロンプト情報も残すことで、後から「なぜこの文章になったか」を追跡・改善できる
- **エラー時の段階的プロンプト簡略化により、システム障害時も安定した投稿継続が可能**