# 📋 POSL V1.0 アーキテクチャ移行 技術調査報告書

**調査期間**: 2025年11月16日〜17日  
**対象システム**: POSL V1.0  
**移行方向**: Lambda+DynamoDB → EC2+RDS(MySQL)+S3  
**調査ステータス**: ✅ **完了**  
**移行判定**: ✅ **移行実行決定**  
**次ステップ**: 移行実行計画書作成・実装開始

---

## 📊 現状システム構成分析（完了）

### 1. 技術アーキテクチャ概要

#### 現在の構成
```
フロントエンド: Next.js 14 + TypeScript + Tailwind CSS
バックエンド: AWS Lambda + Node.js 18.x (TypeScript)
データベース: DynamoDB（5テーブル構成）
ストレージ: S3（音声ファイル保存）
スケジューラー: EventBridge
API: API Gateway + Lambda
認証: Secrets Manager（APIキー管理）
```

### 2. DynamoDB テーブル構成

| テーブル名 | プライマリキー | GSI | 用途 |
|-----------|--------------|-----|------|
| **users** | userId(PK) | なし | ユーザー基本情報 |
| **settings** | userId(PK), settingType(SK) | なし | 全設定データ（7種類）|
| **postLogs** | userId(PK), postId(SK) | timestamp-index | 投稿履歴・ステータス |
| **diaries** | userId(PK), diaryId(SK) | created-at-index | 音声日記データ |
| **personaProfiles** | userId(PK) | なし | 人格プロファイル |

### 3. 既存コードベース分析

#### 3.1 PromptEngine クラス（核心部分）
- **実装状況**: 完全実装済み（98%テストカバレッジ）
- **DynamoDB依存度**: 高い（6つの設定取得メソッド）
- **主要メソッド**:
  - `getWeekThemeSettings()` - 曜日テーマ取得
  - `getEventSettings()` - イベント設定取得
  - `getTrendSettings()` - トレンド設定取得
  - `getToneSettings()` - トーン設定取得
  - `getTemplateSettings()` - テンプレート設定取得
  - `getPromptSettings()` - プロンプト設定取得
  - `getPersonaProfile()` - 人格プロファイル取得
  - `getRecentDiaryContext()` - 日記コンテキスト取得

#### 3.2 DynamoDBHelper クラス
- **共通ライブラリ**: 全Lambda関数で使用
- **主要メソッド**: `getItem()`, `putItem()`, `updateItem()`, `deleteItem()`, `scan()`, `query()`
- **設定管理**: environment variables経由でエンドポイント切り替え

#### 3.3 API エンドポイント構成
```
設定系API: 7エンドポイント（/settings/*）
投稿系API: 3エンドポイント（/posts/*）
日記系API: 2エンドポイント（/diary/*）
```

---

## 🔄 データベース層移行設計分析

### 1. NoSQL → RDBMS スキーマ設計

#### 1.1 テーブル設計変更

**現在（DynamoDB）**:
```javascript
// settings テーブル（複合キー）
{
  userId: "user123",
  settingType: "week-theme", 
  data: { monday: "...", tuesday: "..." },
  updatedAt: "2024-11-16T10:00:00Z"
}
```

**移行後（MySQL）**:
```sql
-- 設定テーブル正規化
CREATE TABLE settings (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id VARCHAR(255) NOT NULL,
    setting_type ENUM('post-time', 'week-theme', 'event', 'trend', 'tone', 'template', 'prompt', 'x-auth') NOT NULL,
    data JSON NOT NULL,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_user_setting (user_id, setting_type),
    UNIQUE KEY unique_user_setting (user_id, setting_type)
);
```

#### 1.2 全テーブル MySQL スキーマ設計

```sql
-- ユーザーテーブル
CREATE TABLE users (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id VARCHAR(255) UNIQUE NOT NULL,
    email VARCHAR(255) UNIQUE,
    x_user_id VARCHAR(255),
    x_username VARCHAR(255),
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    INDEX idx_user_id (user_id),
    INDEX idx_email (email)
);

-- 投稿ログテーブル
CREATE TABLE post_logs (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id VARCHAR(255) NOT NULL,
    post_id VARCHAR(255) NOT NULL,
    content TEXT NOT NULL,
    timestamp TIMESTAMP NOT NULL,
    x_post_id VARCHAR(255),
    prompt TEXT NOT NULL,
    trend_data JSON,
    success BOOLEAN NOT NULL,
    error TEXT,
    
    INDEX idx_user_timestamp (user_id, timestamp),
    INDEX idx_post_id (post_id),
    UNIQUE KEY unique_user_post (user_id, post_id)
);

-- 日記テーブル  
CREATE TABLE diaries (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id VARCHAR(255) NOT NULL,
    diary_id VARCHAR(255) NOT NULL,
    original_text TEXT,
    audio_file_url VARCHAR(500),
    extracted_persona_traits JSON,
    emotion_tags JSON,
    transcription_status ENUM('pending', 'processing', 'completed', 'failed'),
    s3_key VARCHAR(500),
    duration INT,
    file_size BIGINT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    processed_at TIMESTAMP NULL,
    
    INDEX idx_user_created (user_id, created_at),
    INDEX idx_diary_id (diary_id),
    UNIQUE KEY unique_user_diary (user_id, diary_id)
);

-- 人格プロファイルテーブル
CREATE TABLE persona_profiles (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id VARCHAR(255) UNIQUE NOT NULL,
    summary TEXT NOT NULL,
    traits JSON NOT NULL,
    common_topics JSON,
    speaking_style JSON NOT NULL,
    last_updated TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    diary_count INT DEFAULT 0,
    
    INDEX idx_user_id (user_id)
);
```

#### 1.3 データ型マッピング分析

| DynamoDB型 | MySQL型 | 移行考慮事項 |
|-----------|---------|-------------|
| String | VARCHAR/TEXT | 文字数制限設定必要 |
| Number | INT/BIGINT/DECIMAL | 精度・範囲確認必要 |
| Boolean | BOOLEAN | 直接マッピング可能 |
| Map/Object | JSON | MySQL 5.7以降サポート |
| List | JSON | 配列としてJSON格納 |
| StringSet | JSON | JSON配列に変換 |

### 2. データベースアクセス層改修

#### 2.1 DynamoDBHelper → MySQLHelper変換

**変更が必要な主要メソッド**:
```typescript
// 現在のDynamoDB実装
class DynamoDBHelper {
  static async getItem<T>(tableName: string, key: Record<string, any>): Promise<T | null>
  static async putItem<T>(tableName: string, item: T): Promise<void>
  static async scan<T>(tableName: string, filterExpression?: string, ...): Promise<T[]>
  static async query<T>(tableName: string, keyCondition: string, ...): Promise<T[]>
}

// 移行後のMySQL実装
class MySQLHelper {
  static async findOne<T>(tableName: string, where: Record<string, any>): Promise<T | null>
  static async create<T>(tableName: string, data: T): Promise<void>
  static async find<T>(tableName: string, where?: Record<string, any>, ...): Promise<T[]>
  static async update<T>(tableName: string, where: Record<string, any>, data: Partial<T>): Promise<void>
}
```

#### 2.2 PromptEngine 改修範囲

**影響を受ける主要メソッド**:
1. `getWeekThemeSettings()` - settingsテーブルクエリ変更
2. `getEventSettings()` - settingsテーブルクエリ変更  
3. `getTrendSettings()` - settingsテーブルクエリ変更
4. `getToneSettings()` - settingsテーブルクエリ変更
5. `getTemplateSettings()` - settingsテーブルクエリ変更
6. `getPromptSettings()` - settingsテーブルクエリ変更
7. `getPersonaProfile()` - persona_profilesテーブルクエリ変更
8. `getRecentDiaryContext()` - diariesテーブルクエリ変更

**改修例**:
```typescript
// 現在のDynamoDB実装
private async getWeekThemeSettings(): Promise<WeekThemeSettings> {
  const setting = await DynamoDBHelper.getItem(ENV.SETTINGS_TABLE, {
    userId: this.userId,
    settingType: 'week-theme'
  });
  return setting?.data || defaultWeekTheme;
}

// MySQL移行後の実装
private async getWeekThemeSettings(): Promise<WeekThemeSettings> {
  const setting = await MySQLHelper.findOne('settings', {
    user_id: this.userId,
    setting_type: 'week-theme'
  });
  return setting?.data || defaultWeekTheme;
}
```

---

## ⚡ 実行環境移行設計分析（完了）

### 1. Lambda → EC2 移行の技術的課題

#### 1.1 EventBridge → node-cron 移行設計

**現在（EventBridge）**:
```yaml
# serverless.yml - 現在の実装
events:
  - schedule: 
      rate: cron(0 20 * * ? *)  # 毎日20:00 JST
      enabled: true
      input:
        userId: "test-user-001"
```

**移行後（node-cron）**:
```typescript
import cron from 'node-cron';
import { generateAndPost } from './scheduler/generateAndPost';

class SchedulerService {
  private jobs: Map<string, cron.ScheduledTask> = new Map();

  // 毎日20:00の自動投稿
  setupDailyPosting() {
    const job = cron.schedule('0 20 * * *', async () => {
      try {
        const users = await this.getActiveUsers();
        for (const user of users) {
          await generateAndPost(user.userId);
        }
        console.log(`Daily posts generated for ${users.length} users`);
      } catch (error) {
        console.error('Daily post generation failed:', error);
        await this.sendErrorNotification(error);
      }
    }, {
      timezone: "Asia/Tokyo",
      scheduled: true
    });
    
    this.jobs.set('daily-posting', job);
  }

  // 週次人格プロファイル更新
  setupWeeklyPersonaUpdate() {
    const job = cron.schedule('0 2 * * 1', async () => { // 毎週月曜2:00
      try {
        await this.updateAllPersonaProfiles();
      } catch (error) {
        console.error('Weekly persona update failed:', error);
      }
    }, {
      timezone: "Asia/Tokyo"
    });
    
    this.jobs.set('weekly-persona', job);
  }

  // 日次トレンド更新
  setupDailyTrendUpdate() {
    const job = cron.schedule('0 */6 * * *', async () => { // 6時間ごと
      try {
        await this.updateTrendData();
      } catch (error) {
        console.error('Trend update failed:', error);
      }
    });
    
    this.jobs.set('trend-update', job);
  }
}
```

#### 1.2 プロセス管理方式

**推奨構成**: PM2 + systemd + Docker
```javascript
// ecosystem.config.js
module.exports = {
  apps: [{
    name: 'posl-backend',
    script: 'dist/index.js',
    instances: 1, // CPUコア数に応じて調整可能
    exec_mode: 'fork', // cronジョブのため fork mode推奨
    autorestart: true,
    watch: false,
    max_memory_restart: '1G',
    env: {
      NODE_ENV: 'production',
      PORT: 3001,
      DB_HOST: 'localhost',
      DB_PORT: 3306,
      DB_NAME: 'posl_production',
      LOG_LEVEL: 'info'
    },
    error_file: '/var/log/posl/error.log',
    out_file: '/var/log/posl/out.log',
    log_file: '/var/log/posl/combined.log',
    log_date_format: 'YYYY-MM-DD HH:mm:ss Z',
    time: true,
    // 再起動戦略
    min_uptime: '10s',
    max_restarts: 3,
    restart_delay: 4000
  }]
};
```

**systemd サービス設定**:
```ini
# /etc/systemd/system/posl.service
[Unit]
Description=POSL Backend Service
After=network.target mysql.service
Requires=mysql.service

[Service]
Type=forking
User=posl
Group=posl
WorkingDirectory=/opt/posl
ExecStart=/usr/bin/pm2 start ecosystem.config.js --env production
ExecReload=/usr/bin/pm2 reload all
ExecStop=/usr/bin/pm2 stop all
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

#### 1.3 リソース要件・使用量分析

**現在のLambda仕様**:
```
メモリ: 512MB-1024MB （関数ごと）
実行時間: 最大15分
同時実行数: 1000（デフォルト制限）
コールドスタート: 1-3秒
料金: 実行時間・リクエスト数・メモリ使用量基準
```

**EC2移行後の推奨仕様**:
```
インスタンスタイプ: t3.medium (2vCPU, 4GB RAM)
想定負荷:
- アイドル時: CPU 2-5%, Memory 100-200MB
- API処理時: CPU 10-20%, Memory 300-400MB  
- 投稿生成時: CPU 30-50%, Memory 600-800MB
- ピーク時: CPU 70%, Memory 1.2GB

ストレージ: 20GB EBS (gp3)
ネットワーク: 高度なネットワーク機能有効
```

**負荷パターン分析**:
```
日次パターン:
- 20:00: 投稿生成ピーク (5-10分間)
- 02:00: 週次メンテナンス (月曜のみ)
- その他: API応答 + 管理画面アクセス

月間コスト試算:
- EC2 t3.medium: $30/月
- RDS db.t3.micro: $15/月  
- EBS 20GB: $2/月
- データ転送: $5/月
合計: 約$52/月 (vs Lambda: $10-20/月)
```

### 2. API アーキテクチャ変更

#### 2.1 API Gateway → Express.js移行

**現在（Lambda + API Gateway）**:
```typescript
// 関数ごとに個別ファイル（13個のLambda関数）
export const getSettings: APIGatewayProxyHandler = async (event) => {
  // 個別処理
}
export const updateSettings: APIGatewayProxyHandler = async (event) => {
  // 個別処理  
}
```

**移行後（Express.js統合）**:
```typescript
import express from 'express';
import cors from 'cors';
import helmet from 'helmet';
import rateLimit from 'express-rate-limit';

const app = express();

// ミドルウェア設定
app.use(helmet()); // セキュリティヘッダー
app.use(cors({
  origin: process.env.FRONTEND_URL,
  credentials: true
}));
app.use(express.json({ limit: '10mb' }));

// レート制限
const limiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15分
  max: 100 // IP当たり最大100リクエスト
});
app.use(limiter);

// ルーター設定
import { settingsRouter } from './routes/settings';
import { postsRouter } from './routes/posts';
import { diaryRouter } from './routes/diary';
import { systemRouter } from './routes/system';

app.use('/api/settings', settingsRouter);
app.use('/api/posts', postsRouter);  
app.use('/api/diary', diaryRouter);
app.use('/api/system', systemRouter);

// ヘルスチェック
app.get('/health', (req, res) => {
  res.json({ 
    status: 'ok', 
    timestamp: new Date().toISOString(),
    uptime: process.uptime()
  });
});

const PORT = process.env.PORT || 3001;
app.listen(PORT, () => {
  console.log(`POSL Backend running on port ${PORT}`);
});
```

#### 2.2 認証・ミドルウェア移行

**Secrets Manager → 環境変数移行**:
```typescript
// 現在（Secrets Manager）
const getSecret = async (secretName: string) => {
  const client = new SecretsManagerClient({ region: ENV.REGION });
  const response = await client.send(new GetSecretValueCommand({
    SecretId: secretName
  }));
  return JSON.parse(response.SecretString!);
};

// 移行後（環境変数 + dotenv）
import dotenv from 'dotenv';
dotenv.config();

class ConfigService {
  static get openAIKey(): string {
    return process.env.OPENAI_API_KEY!;
  }
  
  static get xApiCredentials() {
    return {
      apiKey: process.env.X_API_KEY!,
      apiSecret: process.env.X_API_SECRET!,
      accessToken: process.env.X_ACCESS_TOKEN!,
      accessTokenSecret: process.env.X_ACCESS_TOKEN_SECRET!
    };
  }
}
```

#### 2.3 エラーハンドリング強化

```typescript
// グローバルエラーハンドラー
app.use((error: Error, req: Request, res: Response, next: NextFunction) => {
  console.error('Global error handler:', error);
  
  // プロダクション環境では詳細なエラー情報を隠蔽
  const isDevelopment = process.env.NODE_ENV === 'development';
  
  res.status(500).json({
    success: false,
    message: 'Internal server error',
    ...(isDevelopment && { error: error.message, stack: error.stack })
  });
});

// 非同期エラー処理
process.on('unhandledRejection', (reason, promise) => {
  console.error('Unhandled Rejection at:', promise, 'reason:', reason);
  // Graceful shutdown
  process.exit(1);
});
```

### 3. 外部サービス連携への影響

#### 3.1 OpenAI API
**影響**: なし
- HTTP クライアント（axios）による接続は同じ
- レート制限管理は既存ロジック流用可能

#### 3.2 X API  
**影響**: なし
- OAuth1.0a認証ライブラリは流用可能
- ツイート投稿ロジックは変更不要

#### 3.3 トレンド取得API
**影響**: 軽微
- Google Trends: PyTrends ライブラリ継続使用
- Yahoo Trends: スクレイピングロジック継続使用
- 定期実行がEventBridge → node-cronに変更のみ

### 4. フロントエンドへの影響

#### 4.1 API エンドポイント変更
**現在**: `https://api-gateway-url/dev/settings/post-time`
**移行後**: `https://posl-backend.example.com/api/settings/post-time`

**必要な変更**:
```typescript
// frontend/src/utils/api.ts
const API_BASE_URL = process.env.NODE_ENV === 'production' 
  ? 'https://api.posl.example.com/api'  // EC2エンドポイント
  : 'http://localhost:3001/api';        // ローカル開発

export class ApiClient {
  // 既存のメソッドはそのまま使用可能
  static async post(endpoint: string, data: any) {
    const response = await fetch(`${API_BASE_URL}${endpoint}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });
    return response.json();
  }
}
```

#### 4.2 WebSocket対応（将来的機能拡張）
**メリット**: EC2常駐により、WebSocketでリアルタイム通信が可能に
```typescript
// 将来実装可能な機能
import { Server } from 'socket.io';

const io = new Server(server, {
  cors: { origin: process.env.FRONTEND_URL }
});

// 投稿生成進捗のリアルタイム通知
io.on('connection', (socket) => {
  socket.on('subscribe-post-updates', (userId) => {
    socket.join(`user-${userId}`);
  });
});

// 投稿生成時にリアルタイム通知
const notifyPostProgress = (userId: string, status: string) => {
  io.to(`user-${userId}`).emit('post-update', { status, timestamp: new Date() });
};
```

---

## 🔧 開発作業量分析（完了）

### 1. 現在のコードベース規模

#### 1.1 全体規模
```
バックエンド: 62ファイル, 約5,637行（TypeScript）
フロントエンド: 22ファイル, 約770行（TypeScript/TSX）
テストファイル: 32テストケース（PromptEngine）
```

#### 1.2 DynamoDB依存コード分析

**DynamoDBHelper使用箇所**: 15ファイルで30箇所以上
- `PromptEngine.ts`: 8メソッド（高依存）
- Lambda関数: 13関数で使用
- テストファイル: モック化済み

### 2. コンポーネント別改修範囲

#### 2.1 PromptEngine（核心部分）

**改修範囲**: 中程度
**現在**: DynamoDBHelper による8つの設定取得メソッド
**移行後**: MySQLHelper による同等メソッド

| メソッド | 改修内容 | 工数見積 |
|---------|----------|---------|
| `getWeekThemeSettings()` | クエリ条件変更 | 0.5日 |
| `getEventSettings()` | クエリ条件変更 | 0.5日 |
| `getTrendSettings()` | クエリ条件変更 | 0.5日 |
| `getToneSettings()` | クエリ条件変更 | 0.5日 |
| `getTemplateSettings()` | クエリ条件変更 | 0.5日 |
| `getPromptSettings()` | クエリ条件変更 | 0.5日 |
| `getPersonaProfile()` | テーブル名・クエリ変更 | 0.5日 |
| `getRecentDiaryContext()` | scan→SELECT変更 | 1日 |

**PromptEngine改修合計**: 4.5日

#### 2.2 データアクセス層

**完全新規実装**: MySQLHelper + ORM導入

```typescript
// 新規実装するMySQLHelper
class MySQLHelper {
  // 基本CRUD操作
  static async findOne<T>(table: string, where: Record<string, any>): Promise<T | null>
  static async find<T>(table: string, options?: QueryOptions): Promise<T[]>
  static async create<T>(table: string, data: T): Promise<T>
  static async update<T>(table: string, where: Record<string, any>, data: Partial<T>): Promise<T>
  static async delete(table: string, where: Record<string, any>): Promise<void>
  
  // DynamoDB互換メソッド（移行用）
  static async getItem<T>(table: string, key: Record<string, any>): Promise<T | null>
  static async putItem<T>(table: string, item: T): Promise<void>
  static async scan<T>(table: string, filter?: string): Promise<T[]>
  static async query<T>(table: string, keyCondition: string): Promise<T[]>
}
```

**工数見積**: 
- MySQLHelper実装: 3日
- 接続プール設定: 1日
- エラーハンドリング: 1日
**合計**: 5日

#### 2.3 Lambda関数 → Express.js移行

**13個のLambda関数を統合API化**

| 関数グループ | ファイル数 | 移行内容 | 工数見積 |
|-------------|----------|----------|---------|
| **settings系** | 2ファイル | Express Router化 | 1.5日 |
| **posts系** | 4ファイル | Express Router化 | 2日 |
| **diary系** | 5ファイル | Express Router化 + ファイル処理 | 2.5日 |
| **scheduler系** | 2ファイル | cron job化 | 1.5日 |

**合計**: 7.5日

#### 2.4 データベース移行作業

**スキーマ作成 + データ移行**
- MySQL スキーマ設計・作成: 1日
- DynamoDB → MySQL ETLスクリプト: 2日
- データ整合性確認: 1日
**合計**: 4日

#### 2.5 インフラ・デプロイ移行

**EC2 + RDS環境構築**
- EC2インスタンス設定: 1日
- RDS設定・セキュリティグループ: 1日
- PM2 + systemd設定: 1日
- ドメイン・SSL設定: 1日
- デプロイパイプライン構築: 1日
**合計**: 5日

#### 2.6 フロントエンド影響

**軽微な変更のみ**
- API エンドポイント URL変更: 0.5日
- 環境変数設定変更: 0.5日
**合計**: 1日

### 3. テスト工程見直し

#### 3.1 既存テスト移行

**PromptEngineテスト（32ケース）**
- モック対象をMySQLHelperに変更: 1日
- テストデータファクトリー更新: 0.5日
- **合計**: 1.5日

#### 3.2 新規テスト追加

**統合テスト強化**
- MySQL接続テスト: 1日
- Express.js統合テスト: 1.5日
- end-to-endテスト: 1日
**合計**: 3.5日

### 4. 全体工数見積もり

#### 4.1 開発フェーズ別工数

| フェーズ | 作業内容 | 工数（日） | 備考 |
|---------|----------|-----------|------|
| **Phase 1** | MySQLHelper実装 + スキーマ設計 | 6日 | 基盤構築 |
| **Phase 2** | PromptEngine移行 + テスト | 6日 | 核心機能 |
| **Phase 3** | API層移行（Express.js化） | 7.5日 | 全API統合 |
| **Phase 4** | データ移行 + 検証 | 4日 | 既存データ保全 |
| **Phase 5** | インフラ構築 + デプロイ | 5日 | 運用環境 |
| **Phase 6** | 統合テスト + 調整 | 5日 | 品質保証 |

**開発工数合計**: 33.5日

#### 4.2 追加作業項目

| 項目 | 工数（日） | 必要性 |
|------|-----------|--------|
| ドキュメント更新 | 2日 | 高 |
| 運用マニュアル作成 | 1.5日 | 高 |
| 性能テスト・調整 | 1.5日 | 中 |
| セキュリティ監査 | 1日 | 高 |

**追加工数合計**: 6日

#### 4.3 総工数・期間見積もり

```
総開発工数: 39.5日（約8週間）
推奨実装期間: 10-12週間（バッファ含む）

人員配置案:
- 1名体制: 10-12週間
- 2名体制: 6-8週間（並行作業可能な箇所あり）
```

### 5. リスク要因と対策

#### 5.1 高リスク項目

1. **データ移行の整合性**
   - 対策: 段階的移行 + ロールバック戦略
   - 工数影響: +2日

2. **PromptEngineの動作検証**
   - 対策: 並行テスト実施
   - 工数影響: +1日

3. **24時間稼働の安定性確保**
   - 対策: 段階的負荷テスト
   - 工数影響: +1日

#### 5.2 低リスク項目

1. **フロントエンド影響**
   - APIエンドポイント変更のみ
2. **外部API連携**
   - 変更不要（OpenAI、X API）
3. **既存テストスイート**
   - モック対象変更のみで流用可能

### 6. 段階的移行戦略

#### 6.1 並行運用期間

**フェーズA（準備期間）**: 2週間
- MySQL環境構築
- 新しいAPIサーバー構築
- データ同期仕組み構築

**フェーズB（並行運用）**: 1-2週間  
- 新旧システム両方で動作確認
- 投稿生成ロジックの比較検証
- 段階的トラフィック切り替え

**フェーズC（完全移行）**: 1週間
- 旧システム停止
- DNS切り替え
- 最終検証

**並行運用合計**: 4-5週間追加

---

## 🛡️ 運用・リスク分析（完了）

### 1. EC2+RDS 24時間稼働運用設計

#### 1.1 高可用性アーキテクチャ

**推奨構成**:
```
AZ-a: EC2 Primary (t3.medium) + RDS Primary (db.t3.small)
AZ-b: RDS Standby (Multi-AZ) + EC2 Standby (起動時のみ)
Load Balancer: ALB (Health Check有効)
```

**稼働率目標**: 99.9% (月間約43分のダウンタイム)

#### 1.2 監視・アラート設計

**CloudWatch監視項目**:
```yaml
EC2監視:
  - CPU使用率: >80% で Warning, >90% で Critical
  - メモリ使用率: >85% で Warning, >95% で Critical
  - ディスク使用率: >80% で Warning
  - プロセス監視: PM2プロセス停止で Critical
  
RDS監視:
  - CPU使用率: >70% で Warning
  - 接続数: >80% で Warning  
  - レプリケーション遅延: >30秒で Warning
  - ストレージ使用率: >80% で Warning

アプリケーション監視:
  - HTTP 200レスポンス率: <95% で Warning
  - API応答時間: >2秒で Warning
  - 投稿生成成功率: <90% で Critical
  - cron job実行確認: 毎日20:05にアラート（失敗時）
```

**SNS通知設定**:
- Critical: 即時SMSアラート
- Warning: Emailアラート
- 復旧通知: Emailで確認通知

#### 1.3 バックアップ戦略

**RDSバックアップ**:
```
自動バックアップ: 毎日3:00に実行（7日間保持）
手動スナップショット: 月次（6ヶ月保持）
ポイントインタイム復旧: 35日間有効
リージョン間複製: 月次でセカンダリリージョンに複製
```

**アプリケーションバックアップ**:
```
設定ファイル: Gitリポジトリでバージョン管理
ログファイル: S3に日次アップロード
音声ファイル: S3（既存）+ Glacier長期保存
```

#### 1.4 災害復旧計画

| 障害レベル | RTO目標 | RPO目標 | 復旧手順 |
|-----------|---------|---------|----------|
| **EC2プロセス停止** | 5分 | 0分 | PM2自動再起動 |
| **EC2インスタンス障害** | 15分 | 5分 | ALBフェイルオーバー |
| **AZ障害** | 30分 | 15分 | Multi-AZ RDS切り替え |
| **リージョン障害** | 4時間 | 1時間 | セカンダリリージョン復旧 |

### 2. セキュリティ設計

#### 2.1 ネットワークセキュリティ

**VPC設計**:
```
Public Subnet: ALB のみ
Private Subnet: EC2, RDS
NAT Gateway: アウトバウンド通信用

セキュリティグループ:
- ALB: 443ポートのみ外部公開
- EC2: ALBからの3001ポートのみ許可
- RDS: EC2からの3306ポートのみ許可
```

**WAF設定**:
- SQLインジェクション防御
- XSS攻撃防御
- レート制限（IP単位）
- 地域制限（日本のみ許可）

#### 2.2 アクセス制御

**IAMロール設計**:
```yaml
EC2Role:
  Permissions:
    - s3:GetObject, s3:PutObject (音声バケットのみ)
    - secretsmanager:GetSecretValue (API key取得のみ)
    - cloudwatch:PutMetricData (監視データ送信)
  
RDSRole:
  Permissions:
    - Enhanced Monitoring用
    - Performance Insights用
```

**SSH接続制御**:
- Session Manager経由のみ（SSH直接不可）
- MFA必須
- 操作ログ全記録

#### 2.3 データ暗号化

**保存時暗号化**:
- RDS: 暗号化有効（AWS KMS）
- S3: 暗号化有効（AES-256）
- EBS: 暗号化有効（AWS KMS）

**転送時暗号化**:
- HTTPS必須（HTTP → HTTPSリダイレクト）
- TLS 1.2以上のみ許可
- RDS接続は必ずSSL

### 3. スケーラビリティ分析

#### 3.1 リソース使用予測

**現在の想定負荷**:
```
ユーザー数: 1名（テスト運用）
投稿頻度: 1日1回
API呼び出し: 100回/日
音声アップロード: 週3-5回
```

**将来予測（1年後）**:
```
ユーザー数: 10-50名
投稿頻度: 10-50回/日  
API呼び出し: 1,000-5,000回/日
音声アップロード: 週30-150回
```

#### 3.2 スケーリング戦略

**垂直スケーリング（優先）**:
```
現在: t3.medium (2vCPU, 4GB)
↓ 負荷増加時
次段: t3.large (2vCPU, 8GB) - コスト+$30/月
↓ さらに増加時  
次段: c5.large (2vCPU, 4GB) - CPU最適化
```

**水平スケーリング（将来）**:
```
ALB + Auto Scaling Group
最小: 1インスタンス
最大: 3インスタンス
スケールアウト条件: CPU >70% × 5分間
```

#### 3.3 データベーススケーリング

**読み取りレプリカ（将来）**:
- 負荷分散: 書き込み→Primary, 読み取り→Replica
- コスト: +$15-25/月
- 実装工数: 2日

### 4. 運用コスト分析

#### 4.1 月額コスト詳細

| リソース | スペック | 月額費用 | 備考 |
|---------|----------|---------|------|
| **EC2** | t3.medium | $30 | 24時間稼働 |
| **RDS** | db.t3.small | $25 | Multi-AZ有効 |
| **EBS** | 30GB gp3 | $3 | OS+アプリ |
| **ALB** | 標準 | $20 | 固定費 |
| **CloudWatch** | 監視・ログ | $10 | 詳細監視 |
| **S3** | 音声保存 | $5 | 既存と同等 |
| **Route53** | DNS管理 | $1 | ドメイン管理 |
| **Backup** | RDS+EBS | $5 | 7日間保持 |

**月額合計**: 約$99 (約14,500円)

#### 4.2 現在のLambda+DynamoDBとの比較

| 項目 | Lambda+DynamoDB | EC2+RDS | 差額 |
|------|-----------------|---------|------|
| **基本料金** | $15-25/月 | $99/月 | +$74-84/月 |
| **運用工数** | 低（サーバーレス） | 中（監視・保守必要） | +10時間/月 |
| **可用性** | 99.95% | 99.9%（設計次第） | -0.05% |
| **スケーラビリティ** | 自動（無制限） | 手動（上限あり） | - |
| **管理負担** | AWS管理 | 自己管理 | +運用負担 |

**年間追加コスト**: 約$900-1,000 + 運用工数コスト

#### 4.3 コスト最適化案

**段階的移行によるコスト削減**:
```
Phase 1: 最小構成（$60/月）
- EC2: t3.small
- RDS: db.t3.micro (single-AZ)
- 基本監視のみ

Phase 2: 中間構成（$80/月）  
- EC2: t3.medium
- RDS: db.t3.small (single-AZ)
- 詳細監視追加

Phase 3: 本格運用（$99/月）
- Multi-AZ有効
- フル監視・アラート
```

### 5. 運用リスク評価

#### 5.1 高リスク要因

**1. MySQL運用経験の活用**
- **リスク**: 設定ミスによる性能劣化
- **対策**: 初期設定レビュー + 性能監視
- **確率**: 中
- **影響**: 中

**2. 24時間稼働の安定性**
- **リスク**: 夜間障害時の対応遅延
- **対策**: 自動復旧 + 緊急連絡体制
- **確率**: 低
- **影響**: 高

**3. データ移行時の整合性**
- **リスク**: DynamoDB→MySQL移行でデータ欠損
- **対策**: 段階的移行 + 検証スクリプト
- **確率**: 低
- **影響**: 高

#### 5.2 中リスク要因

**1. セキュリティ設定**
- **リスク**: 設定不備による侵入
- **対策**: セキュリティ監査 + 定期確認
- **確率**: 低
- **影響**: 高

**2. コスト超過**
- **リスク**: 予想以上のリソース消費
- **対策**: 詳細監視 + アラート設定
- **確率**: 中
- **影響**: 低

#### 5.3 低リスク要因

**1. 外部API連携**
- 既存ライブラリ流用で技術的リスクなし

**2. フロントエンド影響**
- URLの変更のみで最小限の改修

### 6. 推奨運用体制

#### 6.1 運用担当者スキル要件

**必須スキル**:
- MySQL運用経験（3年以上）
- Linux系OS管理経験
- AWS基本サービス知識
- Node.js アプリケーション保守経験

**推奨スキル**:
- CloudWatch監視設計
- PM2プロセス管理
- セキュリティ監査経験

#### 6.2 定期メンテナンス計画

**日次（自動）**:
- ログローテーション
- RDSバックアップ
- ヘルスチェック結果確認

**週次**:
- システムリソース使用率確認
- セキュリティパッチ確認
- エラーログ分析

**月次**:
- 性能レポート作成
- コスト使用量レビュー
- セキュリティ設定確認
- 手動バックアップ実行

---

## 📋 移行実現可能性評価（最終報告）

### ✅ 高い実現可能性の領域

1. **データベース層移行**
   - **技術的実現可能性**: 95%
   - スキーマ設計: JSON型サポートによりスムーズな移行可能
   - 既存データ移行: ETLスクリプトで完全対応可能
   - パフォーマンス: インデックス最適化でDynamoDB同等以上可能

2. **PromptEngine移行**
   - **技術的実現可能性**: 90%
   - コア実装完成済み（98%テストカバレッジ）
   - DB接続部分のみの局所的変更
   - 既存テストスイート活用で品質保証可能

3. **スケジューラー移行**
   - **技術的実現可能性**: 95%
   - node-cron: 成熟したライブラリで高信頼性
   - PM2によるプロセス管理で24時間稼働可能
   - EventBridgeより詳細な制御可能

### ⚠️ 注意が必要な領域

1. **運用負荷増加**
   - **現在**: AWS完全管理（運用工数ほぼ0）
   - **移行後**: 月10時間程度の監視・保守必要
   - **対策**: CloudWatch詳細監視とアラート自動化

2. **コスト増加**
   - **現在**: 月額$15-25
   - **移行後**: 月額$99（約3-4倍）
   - **年間追加コスト**: $900-1,000

3. **可用性の自己責任**
   - **現在**: AWS 99.95%保証
   - **移行後**: 設計・運用次第（目標99.9%）

### 🔴 高リスク要因

1. **初期移行リスク**
   - データ整合性確保の重要性
   - 40年のMySQL経験活用による緩和可能

2. **夜間障害対応**  
   - 24時間監視体制が理想
   - 自動復旧機能で緩和可能

---

## 🎯 総合判定・推奨事項

### 1. 技術的実現可能性評価

**総合評価**: **90% - 高い実現可能性**

| 評価項目 | スコア | 根拠 |
|---------|--------|------|
| **技術的難易度** | 85/100 | 既存アーキテクチャとの親和性高い |
| **既存資産活用** | 95/100 | PromptEngineほぼそのまま活用可能 |
| **開発工数の妥当性** | 80/100 | 39.5日間は現実的な範囲 |
| **リスク管理可能性** | 85/100 | 段階的移行で主要リスク緩和可能 |

### 2. 移行判断マトリックス

#### 2.1 移行を推奨する条件

**✅ 以下の条件が揃えば移行を強く推奨**:

1. **運用工数の確保**
   - 月10-15時間の監視・保守時間を確保可能
   - MySQL運用スキルの40年経験を活用したい

2. **コスト増の許容**
   - 年間$900-1,000の追加コスト許容可能
   - 安定性・制御性に投資する価値を認める

3. **開発期間の確保**
   - 10-12週間の開発期間を確保可能
   - 段階的移行による並行運用期間も許容

#### 2.2 移行を見送る条件

**🛑 以下の場合は現行維持を推奨**:

1. **コスト重視**
   - 現在の低コスト運用を最優先
   - サーバーレスの自動スケール性を重視

2. **運用負荷回避**
   - AWSフルマネージド環境を維持したい
   - 24時間稼働の責任を負いたくない

3. **開発リソース不足**
   - 2-3ヶ月の開発期間確保が困難
   - 他の優先度高い機能開発がある

### 3. 段階的移行ロードマップ

#### Option A: 完全移行（推奨）
```
Phase 1 (2週): 環境構築 + 基盤実装
Phase 2 (3週): PromptEngine移行 + テスト
Phase 3 (3週): API統合 + データ移行
Phase 4 (2週): 本番運用開始 + 最適化
Phase 5 (2週): 旧システム廃止 + 文書化

総期間: 12週間
総工数: 39.5日 + α
```

#### Option B: 段階的移行
```
Step 1: ローカル開発環境でMySQL検証（2週間）
Step 2: PromptEngine単体移行テスト（2週間）
Step 3: 並行運用での動作確認（1ヶ月）
Step 4: 完全切り替え（2週間）

総期間: 3-4ヶ月（リスク最小化）
```

#### Option C: 部分移行（妥協案）
```
データベースのみMySQL移行
Lambda関数は継続使用
スケジューラーはEventBridge継続

工数削減: 約50%
コスト削減: RDS料金のみ追加（月額+$25）
```

### 4. 最終推奨事項

#### 4.1 移行推奨の場合

**推奨理由**:
1. **40年MySQL経験の最大活用**
2. **システム制御性の大幅向上**
3. **将来的な機能拡張への柔軟性**
4. **技術的負債の解消**

**実行計画**:
- **Option A（完全移行）**を推奨
- 開発期間: 12週間で計画
- 予算: 追加年間$1,000-1,200（開発+運用）

#### 4.2 現行維持の場合

**維持理由**:
1. **コスト最優先の方針**
2. **運用負荷ゼロの重視**
3. **AWS managed serviceの信頼性**

**代替案**:
- 現行システムの機能拡張継続
- Phase 5完了まで進行
- 将来的な移行検討（Phase 6後）

### 5. 意思決定のための質問項目

移行判断のために以下を明確化することを推奨：

1. **運用方針**
   - 月10-15時間の監視・保守負荷は許容可能か？
   - MySQL運用経験を活かしたシステム管理を希望するか？

2. **コスト方針** 
   - 年間$900-1,000の追加コストは許容可能か？
   - 安定性・制御性への投資価値をどう評価するか？

3. **開発スケジュール**
   - 10-12週間の開発期間を確保可能か？
   - 他の優先機能開発との兼ね合いは？

4. **リスク許容度**
   - 24時間稼働システムの運用責任を負えるか？
   - 移行時の一時的な不安定性は許容可能か？

---

**最終結論**: 技術的には高い実現可能性（90%）。**移行判断決定済み** - MySQL運用経験の活用と長期的な制御性向上を重視し、**完全移行（Option A）を実行**。

---

## 📋 移行実行決定 - 次のアクション項目

### 🚀 即座に開始すべき作業

1. **移行実行計画書の作成**（優先度：最高）
   - 39.5日の詳細タスク分解
   - 週次スケジュール・マイルストーン設定
   - リスク管理・エスカレーション手順

2. **開発ロードマップ更新**（優先度：高）
   - Phase 6以降を移行作業フェーズに変更
   - 現行Phase 5との並行作業計画
   - 新しい成果指標・KPI設定

3. **アーキテクチャ設計書更新**（優先度：高）
   - 移行後構成の詳細設計
   - セキュリティ・運用設計詳細化
   - EC2+RDS構成図の作成

### 📅 移行スケジュール概要

```
移行開始: 2025年11月18日（月）
完了目標: 2025年2月7日（金）（12週間後）

Week 1-2: 環境構築 + MySQL基盤実装
Week 3-5: PromptEngine移行 + テスト
Week 6-8: API統合 + データ移行
Week 9-10: インフラ構築 + 本番運用開始
Week 11-12: 最適化 + 旧システム廃止
```

### 🎯 移行成功指標

- **技術KPI**: PromptEngine動作一致率 99%以上
- **性能KPI**: API応答時間 現行同等（500ms以内）
- **安定性KPI**: 稼働率 99.9%以上
- **品質KPI**: 全テストケース通過 + 新規テスト追加

---

*📄 調査完了日: 2025年11月17日*  
*🎯 移行開始予定: 2025年11月18日*  
*� 次回更新: 移行実行計画書作成時*